<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BantuJeg - Order Cepat</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="./css/style.css">
    <style>
        .hidden {
            display: none !important;
        }
    </style>
</head>

<body>

    <!-- TASK 2: Beautified Login View -->
    <div id="view-login" class="card-interface hidden"
        style="display: flex; flex-direction: column; justify-content: center; align-items: center; min-height: 100vh; background: #f8fafc;">
        <div style="text-align: center; margin-bottom: 32px;">
            <div class="brand-name" style="font-size: 2.5rem; color: #10B981;">BantuJeg.</div>
            <div class="greeting" style="font-size: 1rem; margin-top: 8px;">Login cepat tanpa password ğŸš€</div>
        </div>
        <div class="input-group"
            style="width: 100%; max-width: 400px; background: white; padding: 24px; border-radius: 24px; box-shadow: 0 4px 20px rgba(0,0,0,0.05);">
            <label
                style="font-size: 0.85rem; font-weight: 700; color: #64748B; margin-bottom: 8px; display: block;">Nomor
                WhatsApp</label>
            <div class="input-wrapper">
                <span class="input-icon">ğŸ“±</span>
                <input type="tel" id="login-phone" placeholder="Contoh: 0895xxxx"
                    style="width: 100%; padding: 16px 16px 16px 48px; border: 2px solid #E2E8F0; border-radius: 16px; font-size: 1rem; font-family: 'Plus Jakarta Sans', sans-serif; outline: none; transition: border 0.3s;"
                    onfocus="this.style.borderColor='#10B981'" onblur="this.style.borderColor='#E2E8F0'">
            </div>
            <button id="btn-request-login" class="btn-cta" style="margin-top: 20px; width: 100%; cursor: pointer;">
                <span id="login-btn-text">Kirim Link Login</span>
            </button>
        </div>
    </div>

    <div id="view-main" class="hidden">
        <header>
            <div class="brand-container">
                <div class="brand-name">BantuJeg.</div>
                <div class="greeting">Siap Antar Kamu! ğŸ‘‹</div>
            </div>
            <div class="pulse" id="status-dot"></div>
        </header>

        <div id="map-wrapper">
            <div id="map-container">
                <div id="map"></div>
            </div>
        </div>

        <div class="card-interface">
            <div id="history-chip" onclick="useHistory()">
                <span id="history-text">ğŸ•’ Pakai Rute Terakhir...</span>
                <div style="font-size:1.2rem">â†ªï¸</div>
            </div>

            <div class="tabs">
                <div class="tab active" onclick="setService('RIDE', this)">ğŸ›µ OJEK</div>
                <div class="tab" onclick="setService('SEND', this)">ğŸ“¦ SEND</div>
                <div class="tab" onclick="setService('FOOD_MART', this)">ğŸœ FOOD & MART</div>
                <div class="tab" onclick="setService('CAR', this)">ğŸš— MOBIL</div>
            </div>

            <div class="input-group">
                <div class="input-wrapper" id="wrapper-origin">
                    <span class="input-icon">ğŸ“</span>
                    <input type="text" id="origin" placeholder="Jemput di mana? (Cari Masjid/Sekolah)"
                        onfocus="setActiveField('pickup'); expandMap()" oninput="handleInput('origin')"
                        aria-label="Lokasi penjemputan" autocomplete="off">
                    <div class="clear-btn" id="clear-origin" onclick="clearInput('origin')" role="button" tabindex="0"
                        aria-label="Hapus lokasi penjemputan">âœ•</div>
                </div>
                <div class="input-actions" id="actions-origin">
                    <div class="action-btn map-picker" onclick="openMapPicker('origin')">ğŸ—ºï¸ Pilih lewat peta</div>
                    <div class="action-btn gps-btn" id="gps-origin" onclick="getCurrentLocation('origin')"
                        style="display:none;">ğŸ¯ Lokasi Saya</div>
                </div>
            </div>

            <div class="input-group">
                <div class="input-wrapper" id="wrapper-destination">
                    <span class="input-icon">ğŸ</span>
                    <input type="text" id="destination" placeholder="Antar ke mana?" onfocus="setActiveField('dropoff')"
                        oninput="handleInput('destination')" aria-label="Lokasi tujuan" autocomplete="off">
                    <div class="clear-btn" id="clear-destination" onclick="clearInput('destination')" role="button"
                        tabindex="0" aria-label="Hapus lokasi tujuan">âœ•</div>
                </div>
                <div class="input-actions" id="actions-destination">
                    <div class="action-btn map-picker" onclick="openMapPicker('destination')">ğŸ—ºï¸ Pilih lewat peta</div>
                    <div class="action-btn gps-btn" id="gps-destination" onclick="getCurrentLocation('destination')"
                        style="display:none;">ğŸ¯ Lokasi Saya</div>
                </div>
            </div>

            <div class="input-group">
                <div class="input-wrapper">
                    <span class="input-icon">ğŸ“</span>
                    <textarea id="note" rows="1" placeholder="Catatan (Pagar hitam, dll)"
                        oninput="updateLink(); toggleClearBtn('note')" aria-label="Catatan tambahan"
                        autocomplete="off"></textarea>
                    <div class="clear-btn" id="clear-note" onclick="clearInput('note')" role="button" tabindex="0"
                        aria-label="Hapus catatan">âœ•</div>
                </div>
                <div class="note-chips">
                    <div class="chip" onclick="addNote('Uang Pas')">Uang Pas</div>
                    <div class="chip" onclick="addNote('Pagar Hitam')">Pagar Hitam</div>
                    <div class="chip" onclick="addNote('Sesuai Titik')">Sesuai Titik</div>
                    <div class="chip" onclick="addNote('Jemput di Gang')">Jemput di Gang</div>
                </div>

                <div id="legal-warning">
                    âš ï¸ Dilarang kirim: Narkoba, Hewan, Senjata & Barang Ilegal. Driver berhak cek barang.
                </div>
            </div>

            <div id="jastip-field" style="display: none;">
                <div class="input-group">
                    <div class="input-wrapper">
                        <span class="input-icon">ğŸ›’</span>
                        <textarea id="items" rows="2" placeholder="List belanjaan..." oninput="updateLink()"
                            aria-label="Daftar belanjaan" autocomplete="off"></textarea>
                    </div>
                </div>
                <div class="input-group">
                    <div class="input-wrapper">
                        <span class="input-icon">ğŸ’°</span>
                        <input type="number" id="est-price" placeholder="Estimasi harga barang (Rp)"
                            oninput="updateLink()" aria-label="Estimasi harga barang" autocomplete="off">
                    </div>
                </div>
            </div>

            <div class="car-options" id="car-options">
                <h4>Pilih Kursi</h4>
                <div class="option-row">
                    <label class="seat-option">
                        <input type="radio" name="car-seat" value="4" checked onchange="handleCarOptionChange()">
                        4 Seat
                    </label>
                    <label class="seat-option">
                        <input type="radio" name="car-seat" value="6" onchange="handleCarOptionChange()">
                        6 Seat
                    </label>
                </div>
                <label class="toll-option">
                    <input type="checkbox" id="car-toll" onchange="handleCarOptionChange()">
                    Lewat Tol (Biaya tol & parkir ditanggung penumpang)
                </label>
            </div>

            <div class="error-card" id="error-card">
                âœ‹ Kejauhan Boss! Max 30km ya.
            </div>

            <div class="price-card" id="price-card">
                <div>
                    <div class="price-dist" id="dist-display">0 km</div>
                    <div class="fake-price" id="fake-price">Rp 0</div>
                    <div class="price-main">
                        <span id="price-display">Rp 0</span>
                        <span class="promo-tag">âš¡ Promo</span>
                    </div>
                </div>
                <div style="text-align: right; font-size: 0.8rem; opacity: 0.7;">
                    Tarif Resmi<br>BantuJeg
                </div>
            </div>

            <!-- Runtime payment selector mount point -->
            <div id="payment-selector-mount"></div>
        </div>

        <div class="bottom-bar">
            <a id="btn-submit" href="#" class="btn-cta disabled">
                <span id="btn-text">Isi Lokasi Dulu</span>
                <div class="spinner" id="loading-spin"></div>
            </a>
        </div>

        <div id="map-picker-modal">
            <div class="picker-header">
                <button class="close-modal-btn" onclick="closeMapPicker()">âœ•</button>
                <h3 id="picker-title">Tentukan Titik Jemput</h3>
            </div>
            <div class="picker-map-container">
                <div id="picker-map"></div>
                <div class="center-pin">
                    <div class="pin-label" id="pin-label">Lokasi Jemput</div>
                    <div class="pin-icon">ğŸ“</div>
                </div>
            </div>
            <div class="picker-footer">
                <div class="address-display" id="picker-address">Mengambil lokasi...</div>
                <button class="confirm-location-btn" onclick="confirmLocation()" disabled id="confirm-picker-btn">Pilih
                    Lokasi Ini</button>
            </div>
        </div>
    </div>

    <!-- TASK 1: Static Init -->
    <script>
        window.APP = window.APP || {};
        const isLocal = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
        window.APP.api = {
            baseUrl: isLocal ? 'http://localhost:3000' : 'https://tanganbantu-backend-422725955268.asia-southeast2.run.app'
        };
        window.APP.auth = {};
        window.APP.session = {};
    </script>

    <script type="module" src="./js/session.js"></script>
    <script type="module" src="./js/auth.js"></script>

    <script type="module">
        // Expose __mapsReady callback for Google Maps async loading
        window.__mapsReady = function () {
            if (window.initializeLegacyUI) {
                window.initializeLegacyUI();
            }
        };

        document.addEventListener('DOMContentLoaded', async () => {
            console.log("ğŸš€ Booting BantuJeg...");

            // 1. Check URL Token
            if (window.APP.auth && window.APP.auth.checkUrlForToken) {
                await window.APP.auth.checkUrlForToken();
            }

            // 2. Check Session
            if (window.APP.session && window.APP.session.isAuthenticated && window.APP.session.isAuthenticated()) {
                document.getElementById('view-login').style.display = 'none';
                document.getElementById('view-login').classList.add('hidden');
                document.getElementById('view-main').classList.remove('hidden');
                // Maps will call __mapsReady when ready, which calls initializeLegacyUI.
                // If Maps already loaded (e.g. cached), call immediately.
                if (window.google && window.google.maps) {
                    window.__mapsReady();
                }
            } else {
                document.getElementById('view-main').classList.add('hidden');
                document.getElementById('view-login').style.display = 'flex';
                document.getElementById('view-login').classList.remove('hidden');
            }

            // 3. Bind Login Button
            const btn = document.getElementById('btn-request-login');
            if (btn) {
                btn.addEventListener('click', () => {
                    const phone = document.getElementById('login-phone').value;
                    if (!phone) { alert("Nomor HP wajib diisi"); return; }

                    if (window.APP.auth && window.APP.auth.requestMagicLink) {
                        window.APP.auth.requestMagicLink(phone);
                    } else {
                        alert("Auth module failed to load.");
                    }
                });
            }
        });
    </script>

    <!-- GOOGLE MAPS & LEGACY LOGIC -->
    <script type="module" src="./js/legacy-logic.js"></script>
    <script
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDwbtq81niH-J_a8N_VS0gAEehuBUCrNWM&libraries=places,geometry&callback=__mapsReady&loading=async"
        async defer></script>
</body>

</html>
