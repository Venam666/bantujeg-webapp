<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#ffffff">
    <title>BantuJeg - Super App</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        :root { 
            --primary: #10B981; 
            --primary-dark: #059669;
            --danger: #EF4444;
            --warning-bg: #FEF9C3;
            --warning-text: #854D0E;
            --dark: #0F172A; 
            --gray: #F8FAFC; 
            --border: #E2E8F0;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: #ffffff; color: var(--dark); height: 100vh; overflow: hidden; display: flex; flex-direction: column; }

        /* --- HEADER --- */
        header { 
            padding: 16px 20px; background: white; z-index: 50; border-bottom: 1px solid #f1f1f1;
            display: flex; justify-content: space-between; align-items: center; flex-shrink: 0;
            transition: transform 0.3s ease;
        }
        body.picking-mode header { transform: translateY(-100%); } /* Hide header in picking mode */

        .brand-name { font-size: 1.25rem; font-weight: 800; color: var(--primary); line-height: 1.1; }
        .greeting { font-size: 0.8rem; color: #64748B; font-weight: 600; }
        .pulse { width: 10px; height: 10px; background: #10B981; border-radius: 50%; animation: pulse 1.5s infinite; box-shadow: 0 0 0 rgba(16, 185, 129, 0.4); }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.4); } 70% { box-shadow: 0 0 0 6px rgba(16, 185, 129, 0); } 100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0); } }

        /* --- MAP ENGINE (DUAL MODE) --- */
        #map-wrapper {
            position: relative;
            width: 100%;
            height: 280px; /* Default Dashboard Height */
            background: #eee;
            flex-shrink: 0;
            transition: height 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
            z-index: 10;
        }

        /* PICKING MODE STATE */
        body.picking-mode #map-wrapper {
            height: 100vh; /* Fullscreen */
            position: fixed;
            top: 0; left: 0;
            z-index: 900;
        }

        #map { width: 100%; height: 100%; }

        /* CENTER PIN (Hidden by default, Visible in Picking Mode) */
        .center-pin-container {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -100%);
            z-index: 1000; pointer-events: none;
            display: none; flex-direction: column; align-items: center;
            transition: transform 0.2s;
        }
        body.picking-mode .center-pin-container { display: flex; }
        
        .pin-label-float {
            background: var(--dark); color: white; padding: 6px 12px; border-radius: 20px;
            font-size: 0.75rem; font-weight: 700; margin-bottom: 12px; white-space: nowrap;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3); opacity: 0.9;
        }
        .pin-head {
            width: 44px; height: 44px; background: var(--dark);
            border: 3px solid white; border-radius: 50% 50% 50% 0; transform: rotate(-45deg);
            box-shadow: 0 10px 25px rgba(0,0,0,0.4); display: flex; align-items: center; justify-content: center;
        }
        .pin-head::after { content: ''; width: 12px; height: 12px; background: var(--primary); border-radius: 50%; }
        .pin-shadow {
            width: 12px; height: 6px; background: rgba(0,0,0,0.3); border-radius: 50%;
            margin-top: -10px; filter: blur(2px); transform: translate(0, 40px);
        }

        /* Animation when dragging map */
        body.map-dragging .center-pin-container { transform: translate(-50%, -130%) scale(1.1); }
        body.map-dragging .pin-shadow { transform: translate(0, 50px) scale(0.6); opacity: 0.5; }

        /* PICKING MODE CONTROLS */
        .picking-controls {
            position: fixed; bottom: 30px; left: 0; width: 100%;
            padding: 0 20px; z-index: 1000; display: none;
            flex-direction: column; gap: 10px;
        }
        body.picking-mode .picking-controls { display: flex; }

        .btn-confirm-loc {
            width: 100%; background: var(--dark); color: white; padding: 16px;
            border-radius: 16px; font-weight: 700; font-size: 1rem; border: none;
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        }
        .btn-cancel-loc {
            position: fixed; top: 20px; left: 20px; z-index: 1000;
            background: white; width: 40px; height: 40px; border-radius: 50%;
            display: none; align-items: center; justify-content: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1); font-weight: 800; color: var(--dark);
        }
        body.picking-mode .btn-cancel-loc { display: flex; }

        /* --- INPUT CARD (BOTTOM HALF) --- */
        .card-interface {
            flex: 1; background: white; padding: 24px 20px;
            border-radius: 24px 24px 0 0; margin-top: -20px;
            position: relative; z-index: 20; box-shadow: 0 -4px 20px rgba(0,0,0,0.05);
            overflow-y: auto; transition: transform 0.3s;
        }
        body.picking-mode .card-interface { transform: translateY(100%); } /* Slide down */

        /* TABS */
        .tabs { display: flex; gap: 8px; margin-bottom: 20px; background: var(--gray); padding: 4px; border-radius: 16px; border: 1px solid var(--border); overflow-x: auto; }
        .tab { flex: 1; padding: 10px; text-align: center; border-radius: 12px; font-weight: 700; font-size: 0.85rem; color: #64748B; cursor: pointer; transition: all 0.2s; white-space: nowrap; }
        .tab.active { background: var(--primary); color: white; box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3); transform: scale(1.02); }

        /* INPUTS */
        .input-group { margin-bottom: 12px; }
        .input-wrapper { 
            position: relative; width: 100%; transition: all 0.3s; 
            border-radius: 16px; border: 1px solid transparent; background: var(--gray); 
            display: flex; align-items: center;
        }
        .input-wrapper.active-field { border-color: var(--primary); background: #F0FDF4; }

        .input-icon-left { padding: 0 12px; font-size: 1.1rem; color: #64748B; }
        
        input[type="text"], textarea, input[type="number"] { 
            flex: 1; padding: 14px 0; background: transparent; border: none;
            font-family: inherit; font-size: 0.9rem; color: var(--dark);
            min-width: 0;
        }
        input:focus { outline: none; }

        /* MAP ICON (THE TRIGGER) */
        .map-trigger-btn {
            padding: 8px 12px; color: var(--primary); font-size: 1.2rem;
            cursor: pointer; border-left: 1px solid #eee; display: flex; align-items: center;
        }
        .map-trigger-btn:active { opacity: 0.5; }

        /* FLOATING GPS (Dashboard & Picking) */
        .floating-gps {
            position: absolute; bottom: 20px; right: 20px;
            background: white; padding: 10px 14px; border-radius: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15); cursor: pointer;
            z-index: 50; font-size: 0.8rem; font-weight: 700; color: var(--dark);
            display: flex; align-items: center; gap: 6px;
        }
        body.picking-mode .floating-gps { bottom: 100px; } /* Move up above button */

        /* AI & BUTTONS */
        .ai-btn {
            background: linear-gradient(135deg, #8B5CF6, #6366F1);
            color: white; border: none; padding: 8px 14px;
            border-radius: 12px; font-size: 0.75rem; font-weight: 700;
            cursor: pointer; display: inline-flex; align-items: center; gap: 6px;
            margin-top: 8px; box-shadow: 0 4px 10px rgba(139, 92, 246, 0.2);
        }
        .ai-btn:disabled { opacity: 0.7; }

        /* PRICE CARD */
        .price-card { 
            background: linear-gradient(135deg, #0F172A 0%, #334155 100%);
            color: white; padding: 16px; border-radius: 16px;
            display: none; align-items: center; justify-content: space-between;
            margin-top: 16px; box-shadow: 0 10px 30px -10px rgba(15, 23, 42, 0.3);
        }
        .fake-price { font-size: 0.75rem; text-decoration: line-through; color: #94A3B8; }
        .price-main { font-size: 1.5rem; font-weight: 800; }

        /* BOTTOM BAR */
        .bottom-bar { 
            background: white; padding: 16px 20px; border-top: 1px solid #eee; 
            position: fixed; bottom: 0; left: 0; width: 100%; z-index: 100;
        }
        .btn-cta {
            display: flex; justify-content: center; align-items: center; width: 100%;
            background: var(--primary); color: white; padding: 16px; border-radius: 16px;
            font-weight: 700; font-size: 1.1rem; text-decoration: none;
            transition: transform 0.2s; box-shadow: 0 10px 20px rgba(16, 185, 129, 0.3);
        }
        .btn-cta.disabled { background: #cbd5e1; box-shadow: none; pointer-events: none; }
        
        .spinner { border: 3px solid rgba(255,255,255,0.3); border-radius: 50%; border-top: 3px solid white; width: 20px; height: 20px; animation: spin 1s linear infinite; display: none; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <header>
        <div class="brand-name">BantuJeg.</div>
        <div class="greeting">Siap Antar Kamu! üëã</div>
    </header>

    <!-- MAP ENGINE -->
    <div id="map-wrapper">
        <div id="map"></div>
        
        <!-- CENTER PIN (PICKING MODE ONLY) -->
        <div class="center-pin-container">
            <div class="pin-label-float" id="pin-address-float">Geser Peta...</div>
            <div class="pin-head"></div>
            <div class="pin-shadow"></div>
        </div>

        <!-- FLOATING GPS -->
        <div class="floating-gps" onclick="getCurrentLocation()">
            <span>üìç</span> Lokasi Saya
        </div>
    </div>

    <!-- PICKING MODE CONTROLS -->
    <div class="btn-cancel-loc" onclick="exitPickingMode()">‚úï</div>
    <div class="picking-controls">
        <button class="btn-confirm-loc" onclick="confirmPickedLocation()">
            Pilih Lokasi Ini
        </button>
    </div>

    <!-- DASHBOARD INTERFACE -->
    <div class="card-interface">
        
        <!-- History Chip -->
        <div id="history-chip" style="background: #ECFDF5; padding: 10px; border-radius: 12px; margin-bottom: 15px; display:none; align-items:center; justify-content:space-between; cursor:pointer;" onclick="useHistory()">
            <span id="history-text" style="font-size:0.8rem; color:#065F46; font-weight:600;"></span>
            <span>‚Ü™Ô∏è</span>
        </div>

        <div class="tabs">
            <div class="tab active" onclick="setService('RIDE', this)">üõµ OJEK</div>
            <div class="tab" onclick="setService('SEND', this)">üì¶ SEND</div>
            <div class="tab" onclick="setService('FOOD_MART', this)">üçú JASTIP</div>
        </div>

        <!-- ORIGIN -->
        <div class="input-group">
            <div class="input-wrapper" id="wrapper-origin">
                <span class="input-icon-left">üìç</span>
                <input type="text" id="origin" placeholder="Jemput di mana?" onfocus="activateField('origin')">
                <div class="map-trigger-btn" onclick="enterPickingMode('origin')">üó∫Ô∏è</div>
            </div>
        </div>

        <!-- DESTINATION -->
        <div class="input-group">
            <div class="input-wrapper" id="wrapper-destination">
                <span class="input-icon-left">üèÅ</span>
                <input type="text" id="destination" placeholder="Antar ke mana?" onfocus="activateField('destination')">
                <div class="map-trigger-btn" onclick="enterPickingMode('destination')">üó∫Ô∏è</div>
            </div>
        </div>

        <!-- NOTE -->
        <div class="input-group">
            <div class="input-wrapper">
                <span class="input-icon-left">üìù</span>
                <input type="text" id="note" placeholder="Catatan (Pagar hitam, dll)" oninput="updateLink()">
            </div>
            <!-- AI Feature -->
            <div style="display:flex; justify-content: flex-end;">
                <button class="ai-btn" id="ai-note-btn" onclick="refineNoteWithAI()">
                    <span>‚ú®</span> Perjelas (AI)
                </button>
            </div>
        </div>

        <!-- JASTIP FIELDS -->
        <div id="jastip-field" style="display: none;">
            <div class="input-group">
                <div class="input-wrapper">
                    <span class="input-icon-left">üõí</span>
                    <textarea id="items" rows="2" placeholder="List belanjaan..." oninput="updateLink()"></textarea>
                </div>
                <button class="ai-btn" id="ai-order-btn" onclick="formatOrderWithAI()">
                    <span>‚ú®</span> Rapikan (AI)
                </button>
            </div>
            <div class="input-group">
                <div class="input-wrapper">
                    <span class="input-icon-left">üí∞</span>
                    <input type="number" id="est-price" placeholder="Estimasi harga barang (Rp)" oninput="updateLink()">
                </div>
            </div>
        </div>

        <!-- PRICE DISPLAY -->
        <div class="price-card" id="price-card">
            <div>
                <div style="font-size:0.8rem; opacity:0.8;" id="dist-display">0 km</div>
                <div class="fake-price" id="fake-price">Rp 0</div>
                <div class="price-main" id="price-display">Rp 0</div>
            </div>
            <div style="text-align: right; font-size: 0.8rem; opacity: 0.7;">Tarif Final</div>
        </div>
        
        <div style="height: 100px;"></div>
    </div>

    <div class="bottom-bar">
        <a id="btn-submit" href="#" class="btn-cta disabled">
            <span id="btn-text">Lengkapi Data</span>
            <div class="spinner" id="loading-spin"></div>
        </a>
    </div>

    <!-- Import Modules -->
    <script type="importmap">
      { "imports": {
          "firebase/app": "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js",
          "firebase/firestore": "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js",
          "@google/generative-ai": "https://esm.run/@google/generative-ai"
      }}
    </script>

    <script type="module">
        import { initializeApp } from "firebase/app";
        import { getFirestore, doc, getDoc } from "firebase/firestore";
        import { GoogleGenerativeAI } from "@google/generative-ai";

        // CONFIG
        const CONFIG_WA = "62895330091464";
        const SALATIGA_CENTER = { lat: -7.3305, lng: 110.5084 };
        const GEMINI_API_KEY = "AIzaSyDDcAVxAk_jY05_VRlJ8KjNPusFyEw714s"; 
        
        window.APP = {
            service: 'RIDE',
            mode: 'DASHBOARD', // DASHBOARD or PICKING
            pickingField: null, // 'origin' or 'destination'
            places: { origin: null, dest: null }, // { lat, lng, address }
            calc: { distance: 0, price: 0 },
            config: { RIDE: null, FOOD_MART: null, SEND: null },
            map: null,
            geocoder: null,
            directionsRenderer: null,
            debounceTimer: null
        };

        // FIREBASE
        const firebaseConfig = {
            apiKey: "AIzaSyAXo3ErccnWYzKPXZsli1j9zsE5_50hO1g",
            authDomain: "tanganbantu-poc.firebaseapp.com",
            projectId: "tanganbantu-poc",
            storageBucket: "tanganbantu-poc.firebasestorage.app",
            messagingSenderId: "236145821183",
            appId: "1:236145821183:web:c390d511bf9da9a86913ca"
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // GEMINI
        let model;
        try {
            const genAI = new GoogleGenerativeAI(GEMINI_API_KEY);
            model = genAI.getGenerativeModel({ model: "gemini-2.0-flash" });
        } catch(e) { console.error("Gemini Error", e); }

        // LOAD PRICING CONFIG
        async function loadConfigs() {
            try {
                const [rideSnap, foodSnap, sendSnap] = await Promise.all([
                    getDoc(doc(db, 'pricing_configs', 'RIDE_v1')),
                    getDoc(doc(db, 'pricing_configs', 'FOOD_MART_v1')),
                    getDoc(doc(db, 'pricing_configs', 'SEND_v1'))
                ]);
                if (rideSnap.exists()) window.APP.config.RIDE = rideSnap.data();
                if (foodSnap.exists()) window.APP.config.FOOD_MART = foodSnap.data();
                if (sendSnap.exists()) window.APP.config.SEND = sendSnap.data();
            } catch (e) { console.error("Config Error", e); }
        }
        loadConfigs();

        // --- GLOBAL FUNCTIONS (EXPOSED) ---

        // 1. MAP INIT
        window.initMap = function() {
            window.APP.geocoder = new google.maps.Geocoder();
            window.APP.directionsService = new google.maps.DirectionsService();
            window.APP.directionsRenderer = new google.maps.DirectionsRenderer({
                suppressMarkers: false,
                polylineOptions: { strokeColor: "#10B981", strokeWeight: 5 }
            });

            const mapOptions = {
                center: SALATIGA_CENTER,
                zoom: 15,
                disableDefaultUI: true,
                zoomControl: false,
                clickableIcons: false,
                minZoom: 12,
                restriction: {
                    latLngBounds: { north: -6.5, south: -8.0, west: 110.0, east: 111.0 },
                    strictBounds: true
                }
            };

            window.APP.map = new google.maps.Map(document.getElementById("map"), mapOptions);
            window.APP.directionsRenderer.setMap(window.APP.map);

            // LISTENERS FOR PICKING MODE
            window.APP.map.addListener("dragstart", () => {
                if (window.APP.mode === 'PICKING') {
                    document.body.classList.add('map-dragging');
                    document.getElementById('pin-address-float').innerText = "Geser Peta...";
                }
            });

            window.APP.map.addListener("idle", () => {
                if (window.APP.mode === 'PICKING') {
                    document.body.classList.remove('map-dragging');
                    // DEBOUNCE REVERSE GEOCODE
                    if (window.APP.debounceTimer) clearTimeout(window.APP.debounceTimer);
                    window.APP.debounceTimer = setTimeout(reverseGeocodeCenter, 500);
                }
            });

            initAutocomplete();
            checkHistory();
        };

        // 2. PICKING MODE LOGIC (UNICORN STYLE)
        window.enterPickingMode = function(field) {
            window.APP.mode = 'PICKING';
            window.APP.pickingField = field;
            document.body.classList.add('picking-mode');
            
            // Resize Map
            google.maps.event.trigger(window.APP.map, "resize");

            // Center map on existing value or user location
            const place = window.APP.places[field];
            if (place && place.lat) {
                window.APP.map.setCenter({ lat: place.lat, lng: place.lng });
                window.APP.map.setZoom(17);
            } else {
                getCurrentLocation(true); // silent move
            }
        };

        window.exitPickingMode = function() {
            window.APP.mode = 'DASHBOARD';
            window.APP.pickingField = null;
            document.body.classList.remove('picking-mode');
            
            // Resize Map back to small
            google.maps.event.trigger(window.APP.map, "resize");
            
            // Fit bounds to route if exists
            if (window.APP.places.origin && window.APP.places.dest) {
                calculateRoute();
            }
        };

        window.confirmPickedLocation = function() {
            // Center coords already processed by 'idle' event into temp storage?
            // Re-fetch center to be sure
            const center = window.APP.map.getCenter();
            const lat = center.lat();
            const lng = center.lng();
            const addr = document.getElementById('pin-address-float').innerText;

            const field = window.APP.pickingField;
            
            // Save to State
            window.APP.places[field] = { lat, lng, address: addr };
            
            // Update Input
            document.getElementById(field).value = addr;
            
            exitPickingMode();
        };

        function reverseGeocodeCenter() {
            const center = window.APP.map.getCenter();
            window.APP.geocoder.geocode({ location: center }, (results, status) => {
                if (status === "OK" && results[0]) {
                    const addr = results[0].formatted_address.replace(/^[A-Z0-9\+]{4,8}(\+[A-Z0-9]{2,})?,\s*/, ''); // Clean
                    document.getElementById('pin-address-float').innerText = addr;
                }
            });
        }

        // 3. AUTOCOMPLETE & ROUTING
        function initAutocomplete() {
            const opts = { componentRestrictions: { country: "id" }, fields: ["geometry", "formatted_address"], strictBounds: false };
            const acOrigin = new google.maps.places.Autocomplete(document.getElementById('origin'), opts);
            const acDest = new google.maps.places.Autocomplete(document.getElementById('destination'), opts);

            acOrigin.addListener('place_changed', () => handlePlaceSelect('origin', acOrigin));
            acDest.addListener('place_changed', () => handlePlaceSelect('destination', acDest));
        }

        function handlePlaceSelect(field, ac) {
            const place = ac.getPlace();
            if (!place.geometry) return;
            
            const addr = place.formatted_address.replace(/^[A-Z0-9\+]{4,8}(\+[A-Z0-9]{2,})?,\s*/, '');
            document.getElementById(field).value = addr;
            
            window.APP.places[field] = {
                lat: place.geometry.location.lat(),
                lng: place.geometry.location.lng(),
                address: addr
            };

            // Focus map on selection
            window.APP.map.setCenter(place.geometry.location);
            window.APP.map.setZoom(16);

            if (window.APP.places.origin && window.APP.places.dest) calculateRoute();
        }

        function calculateRoute() {
            const { origin, dest } = window.APP.places;
            if (!origin || !dest) return;

            window.APP.directionsService.route({
                origin: { lat: origin.lat, lng: origin.lng },
                destination: { lat: dest.lat, lng: dest.lng },
                travelMode: google.maps.TravelMode.TWO_WHEELER
            }, (res, status) => {
                if (status === 'OK') {
                    window.APP.directionsRenderer.setDirections(res);
                    const distKm = res.routes[0].legs[0].distance.value / 1000;
                    window.APP.calc.distance = parseFloat(distKm.toFixed(2));
                    
                    calculatePrice(window.APP.calc.distance);
                }
            });
        }

        function calculatePrice(dist) {
            const service = window.APP.service;
            const config = window.APP.config[service];
            if (!config) return; // Fallback or wait

            if (dist > 25) {
                alert("Kejauhan Boss! Max 25km.");
                document.getElementById('price-card').style.display = 'none';
                return;
            }

            // Simple Tier Logic
            let price = 0;
            // Assuming config structure: { base_price: 6000, base_km: 2, price_per_block: 400, block_size: 0.2 }
            // Or simpler for demo
            const base = config.base_price || 6000;
            const rate = config.price_per_km || 2000;
            
            if (dist <= 2) price = base;
            else price = base + ((dist - 2) * rate);

            price = Math.ceil(price / 500) * 500;
            window.APP.calc.price = price;

            // Update UI
            document.getElementById('price-card').style.display = 'flex';
            document.getElementById('price-display').innerText = `Rp ${price.toLocaleString('id-ID')}`;
            document.getElementById('fake-price').innerText = `Rp ${(price * 1.2).toLocaleString('id-ID')}`;
            document.getElementById('dist-display').innerText = dist + " km";
            
            updateLink();
        }

        // 4. WA LINK & AI
        window.updateLink = function() {
            const btn = document.getElementById('btn-submit');
            const txt = document.getElementById('btn-text');
            const { price, distance } = window.APP.calc;
            const { origin, dest } = window.APP.places;

            if (!price || !origin || !dest) {
                btn.classList.add('disabled');
                txt.innerText = "Lengkapi Data";
                return;
            }

            btn.classList.remove('disabled');
            txt.innerText = `GAS ORDER ‚Ä¢ Rp ${price.toLocaleString('id-ID')}`;

            const note = document.getElementById('note').value;
            const items = document.getElementById('items').value;
            const estPrice = document.getElementById('est-price').value;
            const orderID = `${window.APP.service.substr(0,1)}-${Math.random().toString(36).substr(2,5).toUpperCase()}`;

            let msg = `*ORDER ${window.APP.service}*\nID: ${orderID}\n----------------\n`;
            msg += `üìç Asal: ${origin.address}\n(GPS: ${origin.lat.toFixed(5)}, ${origin.lng.toFixed(5)})\n`;
            msg += `üèÅ Tujuan: ${dest.address}\n(GPS: ${dest.lat.toFixed(5)}, ${dest.lng.toFixed(5)})\n`;
            if(note) msg += `üìù Note: ${note}\n`;
            if(window.APP.service === 'FOOD_MART') msg += `üõí Item: ${items} (Est: ${estPrice})\n`;
            msg += `----------------\nüìè Jarak: ${distance} km\nüí∞ Ongkir: Rp ${price.toLocaleString('id-ID')}\n----------------\nGas Jemput?`;

            btn.href = `https://wa.me/${CONFIG_WA}?text=${encodeURIComponent(msg)}`;
            
            // Save History
            localStorage.setItem('bantujeg_history', JSON.stringify({ origin, dest, note }));
        };

        window.refineNoteWithAI = async function() {
            const input = document.getElementById('note');
            const text = input.value;
            if(!text) return alert("Isi catatan dulu");
            
            const btn = document.getElementById('ai-note-btn');
            btn.innerHTML = "‚è≥..."; btn.disabled = true;
            
            try {
                const prompt = `Rewrite neatly in Indonesian (Driver Note): "${text}"`;
                const res = await model.generateContent(prompt);
                input.value = res.response.text().trim();
                updateLink();
            } catch(e) { console.error(e); }
            btn.innerHTML = "‚ú® Perjelas (AI)"; btn.disabled = false;
        };

        window.formatOrderWithAI = async function() {
            const input = document.getElementById('items');
            const text = input.value;
            if(!text) return alert("Isi list dulu");
            
            const btn = document.getElementById('ai-order-btn');
            btn.innerHTML = "‚è≥..."; btn.disabled = true;
            
            try {
                const prompt = `Format this shopping list to bullet points (Indonesian): "${text}"`;
                const res = await model.generateContent(prompt);
                input.value = res.response.text().trim();
                updateLink();
            } catch(e) { console.error(e); }
            btn.innerHTML = "‚ú® Rapikan (AI)"; btn.disabled = false;
        };

        // 5. UTILS & GPS
        window.activateField = function(field) {
            document.getElementById('wrapper-origin').classList.remove('active-field');
            document.getElementById('wrapper-destination').classList.remove('active-field');
            document.getElementById('wrapper-'+field).classList.add('active-field');
        };

        window.setService = function(type, el) {
            window.APP.service = type;
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            el.classList.add('active');
            
            document.getElementById('jastip-field').style.display = (type === 'FOOD_MART') ? 'block' : 'none';
            
            // Clear inputs logic omitted for brevity, usually reset here
            updateLink();
        };

        window.getCurrentLocation = function(silent = false) {
            if(!navigator.geolocation) return;
            navigator.geolocation.getCurrentPosition(pos => {
                const latlng = { lat: pos.coords.latitude, lng: pos.coords.longitude };
                window.APP.map.setCenter(latlng);
                window.APP.map.setZoom(17);
            });
        };

        function checkHistory() {
            const h = JSON.parse(localStorage.getItem('bantujeg_history'));
            if(h) {
                document.getElementById('history-chip').style.display = 'flex';
                document.getElementById('history-text').innerText = `üïí Terakhir: ${h.origin.address.substr(0,15)}...`;
            }
        }

        window.useHistory = function() {
            const h = JSON.parse(localStorage.getItem('bantujeg_history'));
            if(!h) return;
            window.APP.places.origin = h.origin;
            window.APP.places.dest = h.dest;
            document.getElementById('origin').value = h.origin.address;
            document.getElementById('destination').value = h.dest.address;
            if(h.note) document.getElementById('note').value = h.note;
            calculateRoute();
            document.getElementById('history-chip').style.display = 'none';
        };

        // Script Injector
        const script = document.createElement('script');
        script.src = "https://maps.googleapis.com/maps/api/js?key=AIzaSyAXo3ErccnWYzKPXZsli1j9zsE5_50hO1g&libraries=places,geometry&callback=initMap";
        script.async = true;
        document.body.appendChild(script);

    </script>
</body>
</html>
