<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#ffffff">
    <title>BantuJeg - Order Cepat</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        :root { 
            --primary: #10B981; 
            --primary-dark: #059669;
            --danger: #EF4444;
            --warning-bg: #FEF9C3;
            --warning-text: #854D0E;
            --dark: #0F172A; 
            --gray: #F8FAFC; 
            --border: #E2E8F0;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: #ffffff; color: var(--dark); height: 100vh; overflow: hidden; display: flex; flex-direction: column; }

        /* --- HEADER (FIXED TOP) --- */
        header { 
            padding: 16px 20px; background: white; z-index: 50; border-bottom: 1px solid #f1f1f1;
            display: flex; justify-content: space-between; align-items: center; flex-shrink: 0;
        }
        .brand-name { font-size: 1.25rem; font-weight: 800; color: var(--primary); line-height: 1.1; }
        .greeting { font-size: 0.8rem; color: #64748B; font-weight: 600; }
        .pulse { width: 10px; height: 10px; background: #10B981; border-radius: 50%; animation: pulse 1.5s infinite; box-shadow: 0 0 0 rgba(16, 185, 129, 0.4); }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.4); } 70% { box-shadow: 0 0 0 6px rgba(16, 185, 129, 0); } 100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0); } }

        /* --- MAP CONTAINER (MIDDLE) --- */
        #map-wrapper {
            position: relative;
            width: 100%;
            height: 50vh; /* Dominates view */
            background: #eee;
            flex-shrink: 0;
        }
        #map { width: 100%; height: 100%; }

        /* CENTER PIN (GOJEK STYLE) */
        .center-pin {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -100%); /* Tip exactly at center */
            z-index: 10;
            pointer-events: none; /* Allows map interaction below */
            display: flex;
            flex-direction: column;
            align-items: center;
            transition: transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        
        .pin-head {
            width: 40px; height: 40px;
            background: var(--dark);
            border: 3px solid white;
            border-radius: 50% 50% 50% 0;
            transform: rotate(-45deg);
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            display: flex; align-items: center; justify-content: center;
            margin-bottom: 10px;
        }
        .pin-head::after {
            content: ''; width: 12px; height: 12px; background: var(--primary); border-radius: 50%; transform: rotate(45deg);
        }
        .pin-shadow {
            width: 12px; height: 6px; background: rgba(0,0,0,0.2); border-radius: 50%;
            margin-top: -14px; filter: blur(2px);
            transition: all 0.2s;
        }
        
        .pin-label {
            background: white; padding: 6px 14px; border-radius: 20px;
            font-size: 0.75rem; font-weight: 800; color: var(--dark);
            box-shadow: 0 4px 15px rgba(0,0,0,0.15); margin-bottom: 8px;
            white-space: nowrap; transform: translateY(0); transition: all 0.2s;
        }

        /* Bounce animation when map moves */
        .map-moving .center-pin { transform: translate(-50%, -130%) scale(1.1); opacity: 0.9; }
        .map-moving .pin-shadow { transform: scale(0.6); opacity: 0.5; }

        /* --- INPUT CARD (BOTTOM HALF - OVERLAPPING) --- */
        .card-interface {
            flex: 1;
            background: white;
            padding: 24px 20px;
            border-radius: 24px 24px 0 0;
            margin-top: -20px; /* Overlap map slightly */
            position: relative;
            z-index: 20;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.05);
            overflow-y: auto;
        }

        /* TABS */
        .tabs { display: flex; gap: 8px; margin-bottom: 20px; background: var(--gray); padding: 4px; border-radius: 16px; border: 1px solid var(--border); overflow-x: auto; }
        .tab { flex: 1; padding: 10px; text-align: center; border-radius: 12px; font-weight: 700; font-size: 0.85rem; color: #64748B; cursor: pointer; transition: all 0.2s; white-space: nowrap; }
        .tab.active { background: var(--primary); color: white; box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3); transform: scale(1.02); }

        /* INPUTS */
        .input-group { margin-bottom: 12px; }
        .input-wrapper { position: relative; width: 100%; transition: all 0.3s; border-radius: 16px; border: 1px solid transparent; background: var(--gray); }
        
        .input-wrapper.active-field { 
            border-color: var(--primary);
            background: #F0FDF4;
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
        }

        .input-icon { position: absolute; left: 16px; top: 50%; transform: translateY(-50%); font-size: 1.1rem; z-index: 2; }
        
        input[type="text"], textarea, input[type="number"] { 
            width: 100%; padding: 14px 14px 14px 44px; 
            background: transparent; border: none;
            border-radius: 16px; font-family: inherit; font-size: 0.9rem; color: var(--dark);
            transition: all 0.2s;
            padding-right: 40px; /* Default padding */
        }
        input:focus { outline: none; }
        
        /* DYNAMIC PADDING WHEN GPS BUTTON IS PRESENT */
        .input-wrapper.has-gps input { padding-right: 120px; }

        /* CLEAR BUTTON */
        .clear-btn {
            position: absolute; right: 12px; top: 50%; transform: translateY(-50%);
            width: 20px; height: 20px; border-radius: 50%; background: #E2E8F0;
            color: #64748B; display: flex; align-items: center; justify-content: center;
            font-size: 12px; font-weight: bold; cursor: pointer; z-index: 6;
            display: none; 
        }
        /* Shift Clear Button when GPS is present */
        .input-wrapper.has-gps .clear-btn { right: 90px; }

        /* GPS BUTTON (INLINE) */
        .gps-inline-btn {
            position: absolute; right: 8px; top: 50%; transform: translateY(-50%);
            background: white; border: 1px solid var(--border); color: var(--primary);
            padding: 6px 12px; border-radius: 12px; font-size: 0.75rem; font-weight: 700;
            cursor: pointer; z-index: 7; display: flex; align-items: center; gap: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05); transition: all 0.2s;
        }
        .gps-inline-btn:active { transform: translateY(-50%) scale(0.95); }

        /* AI BUTTONS */
        .ai-btn {
            background: linear-gradient(135deg, #8B5CF6, #6366F1);
            color: white; border: none; padding: 8px 14px;
            border-radius: 12px; font-size: 0.75rem; font-weight: 700;
            cursor: pointer; display: inline-flex; align-items: center; gap: 6px;
            margin-top: 8px; box-shadow: 0 4px 10px rgba(139, 92, 246, 0.2);
            transition: 0.2s;
        }
        .ai-btn:disabled { opacity: 0.7; cursor: not-allowed; }
        .ai-btn:active { transform: scale(0.95); }

        /* HISTORY CHIP */
        #history-chip {
            background: #ECFDF5; border: 1px solid #A7F3D0; color: #065F46;
            padding: 10px 14px; border-radius: 12px; font-size: 0.8rem; font-weight: 600;
            margin-bottom: 16px; display: none; cursor: pointer;
            align-items: center; justify-content: space-between;
        }
        #history-chip span { display: block; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 280px; }

        /* QUICK NOTES */
        .note-chips { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 4px; margin-top: 8px; }
        .chip { background: var(--gray); border: 1px solid var(--border); padding: 4px 10px; border-radius: 12px; font-size: 0.7rem; white-space: nowrap; cursor: pointer; color: var(--text-mute); }

        /* CARDS */
        .price-card { 
            background: linear-gradient(135deg, #0F172A 0%, #334155 100%);
            color: white; padding: 16px; border-radius: 16px;
            display: none; align-items: center; justify-content: space-between;
            margin-top: 16px; box-shadow: 0 10px 30px -10px rgba(15, 23, 42, 0.3);
        }
        .fake-price { font-size: 0.75rem; text-decoration: line-through; color: #94A3B8; }
        .promo-tag { background: rgba(16, 185, 129, 0.2); color: #34D399; font-size: 0.6rem; padding: 2px 6px; border-radius: 4px; margin-left: 6px; }
        .price-main { font-size: 1.5rem; font-weight: 800; }

        /* LEGAL WARNING */
        #legal-warning {
            background: var(--warning-bg); border: 1px solid #FDE047; color: var(--warning-text);
            padding: 10px; border-radius: 12px; font-size: 0.7rem; font-weight: 600;
            margin-top: 10px; display: none;
        }

        /* BOTTOM BAR */
        .bottom-bar { 
            background: white; padding: 16px 20px; border-top: 1px solid #eee; 
            position: fixed; bottom: 0; left: 0; width: 100%; z-index: 100;
        }
        .btn-cta {
            display: flex; justify-content: center; align-items: center; width: 100%;
            background: var(--primary); color: white; padding: 16px; border-radius: 16px;
            font-weight: 700; font-size: 1.1rem; text-decoration: none;
            transition: transform 0.2s; box-shadow: 0 10px 20px rgba(16, 185, 129, 0.3);
            overflow: hidden;
            position: relative;
        }
        .btn-cta:active { transform: scale(0.98); }
        .btn-cta.disabled { background: #cbd5e1; box-shadow: none; pointer-events: none; }
        
        .spinner { border: 3px solid rgba(255,255,255,0.3); border-radius: 50%; border-top: 3px solid white; width: 20px; height: 20px; animation: spin 1s linear infinite; display: none; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <header>
        <div class="brand-container">
            <div class="brand-name">BantuJeg.</div>
            <div class="greeting">Siap Antar Kamu! üëã</div>
        </div>
        <div class="pulse" id="status-dot"></div> 
    </header>

    <!-- MAP SECTION -->
    <div id="map-wrapper">
        <div id="map"></div>
        
        <!-- CENTER PIN OVERLAY -->
        <div class="center-pin" id="center-pin">
            <div class="pin-label" id="pin-label">Set Lokasi</div>
            <div class="pin-head"></div>
            <div class="pin-shadow"></div>
        </div>
    </div>

    <!-- INPUT CARD SECTION -->
    <div class="card-interface">
        
        <!-- HISTORY CHIP -->
        <div id="history-chip" onclick="useHistory()">
            <span id="history-text">üïí Rute Terakhir...</span>
            <div style="font-size:1.2rem">‚Ü™Ô∏è</div>
        </div>

        <div class="tabs">
            <div class="tab active" onclick="setService('RIDE', this)">üõµ OJEK</div>
            <div class="tab" onclick="setService('SEND', this)">üì¶ SEND</div>
            <div class="tab" onclick="setService('FOOD_MART', this)">üçú JASTIP</div>
        </div>

        <!-- ORIGIN -->
        <div class="input-group">
            <div class="input-wrapper active-field" id="wrapper-origin" onclick="activateField('origin')">
                <span class="input-icon">üìç</span>
                <input type="text" id="origin" placeholder="Jemput di mana?" oninput="handleInput('origin')" onfocus="activateField('origin')">
                <div class="clear-btn" id="clear-origin" onclick="clearInput('origin')">‚úï</div>
            </div>
        </div>

        <!-- DESTINATION -->
        <div class="input-group">
            <div class="input-wrapper" id="wrapper-destination" onclick="activateField('destination')">
                <span class="input-icon">üèÅ</span>
                <input type="text" id="destination" placeholder="Antar ke mana?" oninput="handleInput('destination')" onfocus="activateField('destination')">
                <div class="clear-btn" id="clear-destination" onclick="clearInput('destination')">‚úï</div>
            </div>
        </div>

        <!-- DYNAMIC GPS BUTTON (Moved via JS) -->
        <div id="gps-btn-container" style="display:none;">
            <div class="gps-inline-btn" id="btn-gps" onclick="getCurrentLocation()">
                <span>üìç</span> Lokasi Saya
            </div>
        </div>

        <!-- NOTE -->
        <div class="input-group">
            <div class="input-wrapper" id="wrapper-note">
                <span class="input-icon">üìù</span>
                <input type="text" id="note" placeholder="Catatan (Pagar hitam, dll)" oninput="updateLink(); toggleClearBtn('note')">
                <div class="clear-btn" id="clear-note" onclick="clearInput('note')">‚úï</div>
            </div>
            
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <!-- Quick Chips -->
                <div class="note-chips">
                    <div class="chip" onclick="addNote('Pagar Hitam')">Pagar Hitam</div>
                    <div class="chip" onclick="addNote('Uang Pas')">Uang Pas</div>
                    <div class="chip" onclick="addNote('Sesuai Titik')">Sesuai Titik</div>
                </div>
                <!-- Gemini Feature 1 -->
                <button class="ai-btn" id="ai-note-btn" onclick="refineNoteWithAI()">
                    <span>‚ú®</span> Perjelas (AI)
                </button>
            </div>
            
            <!-- Legal Warning (Send Only) -->
            <div id="legal-warning">
                ‚ö†Ô∏è Dilarang kirim: Narkoba, Hewan, Senjata & Barang Ilegal. Driver berhak cek barang.
            </div>
        </div>

        <!-- JASTIP FIELDS -->
        <div id="jastip-field" style="display: none;">
            <div class="input-group">
                <div class="input-wrapper">
                    <span class="input-icon">üõí</span>
                    <textarea id="items" rows="2" placeholder="List belanjaan..." oninput="updateLink()"></textarea>
                </div>
                <!-- Gemini Feature 2 -->
                <button class="ai-btn" id="ai-order-btn" onclick="formatOrderWithAI()">
                    <span>‚ú®</span> Rapikan Pesanan (AI)
                </button>
            </div>
            <div class="input-group">
                <div class="input-wrapper">
                    <span class="input-icon">üí∞</span>
                    <input type="number" id="est-price" placeholder="Estimasi harga barang (Rp)" oninput="updateLink()">
                </div>
            </div>
        </div>

        <!-- PRICE DISPLAY -->
        <div class="price-card" id="price-card">
            <div>
                <div class="price-dist" id="dist-display">0 km</div>
                <div class="fake-price" id="fake-price">Rp 0</div>
                <div class="price-main">
                    <span id="price-display">Rp 0</span> 
                    <span class="promo-tag">‚ö° Promo</span>
                </div>
            </div>
            <div style="text-align: right; font-size: 0.8rem; opacity: 0.7;">
                Tarif Resmi<br>BantuJeg
            </div>
        </div>
        
        <!-- Padding for bottom bar -->
        <div style="height: 100px;"></div>
    </div>

    <div class="bottom-bar">
        <a id="btn-submit" href="#" class="btn-cta disabled">
            <span id="btn-text">Isi Lokasi Dulu</span>
            <div class="spinner" id="loading-spin"></div>
        </a>
    </div>

    <!-- Import Maps for Modules -->
    <script type="importmap">
      {
        "imports": {
          "firebase/app": "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js",
          "firebase/firestore": "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js",
          "firebase/auth": "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js",
          "@google/generative-ai": "https://esm.run/@google/generative-ai"
        }
      }
    </script>

    <!-- MAIN LOGIC (TYPE MODULE) -->
    <script type="module">
        import { initializeApp } from "firebase/app";
        import { getFirestore, doc, getDoc } from "firebase/firestore";
        import { GoogleGenerativeAI } from "@google/generative-ai";

        // CONFIG
        const CONFIG_WA = "62895330091464";
        const SALATIGA_CENTER = { lat: -7.3305, lng: 110.5084 };
        const GEMINI_API_KEY = "AIzaSyDDcAVxAk_jY05_VRlJ8KjNPusFyEw714s"; // GEMINI Key
        
        // APP STATE
        window.APP = {
            service: 'RIDE',
            activeField: 'origin', // 'origin' or 'destination'
            places: { origin: null, dest: null },
            calc: { distance: 0, price: 0 },
            config: { RIDE: null, FOOD_MART: null, SEND: null },
            map: null,
            geocoder: null,
            historyData: null,
            ignoreIdle: false, // Flag to prevent circular updates
            debounceTimer: null
        };

        // FIREBASE INIT
        const firebaseConfig = {
            apiKey: "AIzaSyAekghf6Oydh17aYc_ia1zy3oNDsFK4aww",
            authDomain: "tanganbantu-poc.firebaseapp.com",
            projectId: "tanganbantu-poc",
            storageBucket: "tanganbantu-poc.firebasestorage.app",
            messagingSenderId: "236145821183",
            appId: "1:236145821183:web:c390d511bf9da9a86913ca"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // GEMINI INIT
        let model;
        try {
            const genAI = new GoogleGenerativeAI(GEMINI_API_KEY);
            model = genAI.getGenerativeModel({ model: "gemini-2.0-flash" }); // UPDATED TO 2.0
        } catch(e) {
            console.error("Gemini Init Error:", e);
        }

        // LOAD PRICING
        async function loadConfigs() {
            try {
                const [rideSnap, foodSnap, sendSnap] = await Promise.all([
                    getDoc(doc(db, 'pricing_configs', 'RIDE_v1')),
                    getDoc(doc(db, 'pricing_configs', 'FOOD_MART_v1')),
                    getDoc(doc(db, 'pricing_configs', 'SEND_v1'))
                ]);
                if (rideSnap.exists()) window.APP.config.RIDE = rideSnap.data();
                if (foodSnap.exists()) window.APP.config.FOOD_MART = foodSnap.data();
                if (sendSnap.exists()) window.APP.config.SEND = sendSnap.data();
                console.log("Config Loaded");
            } catch (e) { console.error("Config Error", e); }
        }
        loadConfigs();

        // ------------------------------------------
        // EXPOSE FUNCTIONS TO WINDOW (GLOBAL SCOPE)
        // ------------------------------------------

        // --- GEMINI FUNCTIONS ---
        window.refineNoteWithAI = async function() {
            const input = document.getElementById('note');
            const originalText = input.value.trim();
            const btn = document.getElementById('ai-note-btn');
            
            if (!originalText) { alert("Isi catatannya dulu ya kak."); return; }
            if (!model) { alert("AI belum siap, cek koneksi."); return; }

            const originalBtnText = btn.innerHTML;
            btn.innerHTML = "<span>‚è≥</span>...";
            btn.disabled = true;

            try {
                const prompt = `Rewrite this driver note to be polite, clear, and concise (Indonesian): "${originalText}"`;
                const result = await model.generateContent(prompt);
                const response = result.response.text();
                input.value = response.trim();
                updateLink();
            } catch (e) {
                console.error("AI Error:", e);
                alert("AI lagi sibuk, coba nanti ya.");
            } finally {
                btn.innerHTML = originalBtnText;
                btn.disabled = false;
            }
        };

        window.formatOrderWithAI = async function() {
            const input = document.getElementById('items');
            const originalText = input.value.trim();
            const btn = document.getElementById('ai-order-btn');

            if (!originalText) { alert("Isi list belanjaan dulu ya kak."); return; }
            if (!model) { alert("AI belum siap."); return; }

            const originalBtnText = btn.innerHTML;
            btn.innerHTML = "<span>‚è≥</span>...";
            btn.disabled = true;

            try {
                const prompt = `Format this shopping list into clean bullet points (Indonesian): "${originalText}"`;
                const result = await model.generateContent(prompt);
                const response = result.response.text();
                input.value = response.trim();
                updateLink();
            } catch (e) {
                console.error("AI Error:", e);
                alert("AI lagi sibuk, coba nanti ya.");
            } finally {
                btn.innerHTML = originalBtnText;
                btn.disabled = false;
            }
        };

        // --- MAP INITIALIZATION ---
        window.initMap = function() {
            window.APP.geocoder = new google.maps.Geocoder();
            
            // STRICT BOUNDS (CENTRAL JAVA / SALATIGA)
            const JATENG_BOUNDS = {
                north: -6.5,
                south: -8.0,
                west: 110.0,
                east: 111.0,
            };

            const mapOptions = {
                center: SALATIGA_CENTER,
                zoom: 16,
                minZoom: 12, // Prevent zooming out to world
                restriction: {
                    latLngBounds: JATENG_BOUNDS,
                    strictBounds: true,
                },
                disableDefaultUI: true,
                zoomControl: false,
                clickableIcons: false,
                styles: [
                    { featureType: "poi", elementType: "labels", stylers: [{ visibility: "off" }] }
                ]
            };

            window.APP.map = new google.maps.Map(document.getElementById("map"), mapOptions);

            // CENTER PIN LOGIC (IDLE EVENT)
            window.APP.map.addListener("idle", () => {
                if (window.APP.ignoreIdle) {
                    window.APP.ignoreIdle = false; // Reset flag and skip logic once
                    return;
                }
                
                // Get Center Coords
                const center = window.APP.map.getCenter();
                const lat = center.lat();
                const lng = center.lng();

                // REMOVE MOVING CLASS
                document.getElementById('map-wrapper').classList.remove('map-moving');

                // DEBOUNCE REVERSE GEOCODE
                if (window.APP.debounceTimer) clearTimeout(window.APP.debounceTimer);
                
                window.APP.debounceTimer = setTimeout(() => {
                    reverseGeocode(lat, lng);
                }, 600); // 600ms debounce
            });

            // DRAG EVENT (VISUAL FEEDBACK)
            window.APP.map.addListener("dragstart", () => {
                document.getElementById('map-wrapper').classList.add('map-moving');
            });

            initAutocomplete();
            checkHistory();
            
            // INIT DEFAULT GPS BUTTON POSITION
            setService('RIDE', document.querySelector('.tab'));
        };

        // --- REVERSE GEOCODING ---
        function reverseGeocode(lat, lng) {
            window.APP.geocoder.geocode({ location: { lat, lng } }, (results, status) => {
                if (status === "OK" && results[0]) {
                    const active = window.APP.activeField; // 'origin' or 'destination'
                    const cleanedAddress = cleanAddress(results[0].formatted_address);
                    
                    // Update Input Text
                    const inputEl = document.getElementById(active === 'origin' ? 'origin' : 'destination');
                    
                    // Update value logic
                    if(document.activeElement !== inputEl) { // Only update if user is NOT typing
                        inputEl.value = cleanedAddress;
                    }
                    toggleClearBtn(active === 'origin' ? 'origin' : 'destination');

                    // Update State
                    window.APP.places[active] = results[0]; // Store full place object
                    
                    // Trigger Price Calc if both exist
                    if (window.APP.places.origin && window.APP.places.dest) {
                        calculateRoute();
                    }
                }
            });
        }

        // --- INPUT FOCUS LOGIC (SWITCH ACTIVE FIELD) ---
        window.activateField = function(field) {
            window.APP.activeField = field;
            
            // Visual Update
            document.querySelectorAll('.input-wrapper').forEach(el => el.classList.remove('active-field'));
            document.getElementById(`wrapper-${field}`).classList.add('active-field');
            
            // Update Pin Label
            const label = field === 'origin' ? "üìç Jemput" : "üèÅ Tujuan";
            document.getElementById('pin-label').innerText = label;

            // Move Map to existing location if available
            const place = window.APP.places[field];
            if (place && place.geometry) {
                window.APP.ignoreIdle = true; // Prevent reverse geocoding overriding existing place immediately
                window.APP.map.panTo(place.geometry.location);
                window.APP.map.setZoom(17);
            }
        };

        // --- AUTOCOMPLETE ---
        function initAutocomplete() {
            // Bias to map center
            const center = window.APP.map.getCenter();
            const defaultBounds = {
                north: center.lat() + 0.1,
                south: center.lat() - 0.1,
                east: center.lng() + 0.1,
                west: center.lng() - 0.1,
            };

            const options = {
                bounds: defaultBounds,
                componentRestrictions: { country: "id" },
                fields: ["geometry", "name", "formatted_address"],
                strictBounds: false,
            };

            const acOrigin = new google.maps.places.Autocomplete(document.getElementById('origin'), options);
            const acDest = new google.maps.places.Autocomplete(document.getElementById('destination'), options);

            // Bind to map bounds
            acOrigin.bindTo("bounds", window.APP.map);
            acDest.bindTo("bounds", window.APP.map);

            acOrigin.addListener('place_changed', () => handlePlaceSelect('origin', acOrigin));
            acDest.addListener('place_changed', () => handlePlaceSelect('destination', acDest));
        }

        function handlePlaceSelect(field, ac) {
            const place = ac.getPlace();
            if (!place.geometry) return;

            const inputId = field;
            const cleaned = cleanAddress(place.formatted_address || place.name);
            document.getElementById(inputId).value = cleaned;
            toggleClearBtn(inputId);

            window.APP.places[field] = place;
            
            // MOVE MAP TO SELECTION
            window.APP.ignoreIdle = true; // Don't trigger reverse geocode on pan
            window.APP.map.setCenter(place.geometry.location);
            window.APP.map.setZoom(17);

            // Re-trigger calculation
            if (window.APP.places.origin && window.APP.places.dest) {
                calculateRoute();
            }
        }

        // --- GPS ---
        window.getCurrentLocation = function() {
            if (!navigator.geolocation) { alert("Browser tidak support GPS"); return; }
            
            const btn = document.getElementById('btn-gps');
            const originalText = btn.innerHTML;
            btn.innerHTML = "<span>‚è≥</span>";

            navigator.geolocation.getCurrentPosition(pos => {
                const lat = pos.coords.latitude;
                const lng = pos.coords.longitude;
                const latlng = { lat, lng };

                window.APP.ignoreIdle = false; // Allow reverse geocode to fill address
                window.APP.map.panTo(latlng);
                window.APP.map.setZoom(17);
                btn.innerHTML = originalText;
            }, () => {
                alert("Gagal ambil lokasi GPS.");
                btn.innerHTML = originalText;
            });
        };

        // --- CALCULATION ---
        function calculateRoute() {
            const { origin, dest } = window.APP.places;
            const originVal = document.getElementById('origin').value.trim();
            const destVal = document.getElementById('destination').value.trim();

            if (!origin || !dest || originVal === '' || destVal === '') {
                window.APP.calc.price = 0;
                document.getElementById('price-card').style.display = 'none';
                updateLink();
                return;
            }

            setLoading(true);

            const directionsService = new google.maps.DirectionsService();
            
            directionsService.route({
                origin: origin.geometry.location || origin.geometry.location, 
                destination: dest.geometry.location || dest.geometry.location,
                travelMode: google.maps.TravelMode.TWO_WHEELER,
                avoidTolls: true
            }, (res, status) => {
                setLoading(false);
                if (status === 'OK') {
                    const googleKm = res.routes[0].legs[0].distance.value / 1000;
                    const straightKm = google.maps.geometry.spherical.computeDistanceBetween(
                        res.routes[0].legs[0].start_location,
                        res.routes[0].legs[0].end_location
                    ) / 1000;

                    // PRICING LOGIC
                    const configRide = window.APP.config.RIDE || { distance_logic: { lmf: 1.25, detour_limit: 1.15 } };
                    const logic = configRide.distance_logic || { lmf: 1.25, detour_limit: 1.15 };
                    
                    let finalKm = googleKm;
                    const motorEstimate = straightKm * logic.lmf;
                    if (googleKm > motorEstimate * logic.detour_limit) finalKm = motorEstimate;
                    else if (googleKm < straightKm * 1.05) finalKm = straightKm * 1.10;

                    window.APP.calc.distance = parseFloat(finalKm.toFixed(2));
                    
                    if (window.APP.calc.distance > 25) {
                        alert("Kejauhan Boss! Max 25km.");
                        window.APP.calc.price = 0;
                        updateLink();
                    } else {
                        calculatePrice(finalKm);
                    }
                }
            });
        }

        function calculatePrice(distance) {
            const service = window.APP.service;
            const config = window.APP.config[service];
            if (!config) return;

            let price = 0;
            const tiers = config.pricing_model?.tiers || config.TIERS; 

            if (Array.isArray(tiers)) {
                 const tier = tiers.find(t => distance >= t.min_km && distance < t.max_km) || tiers[tiers.length-1];
                 if (tier.calculation_type === 'FLAT') price = tier.base_price;
                 else price = tier.base_price + ((distance - tier.offset_km) * tier.price_per_km);
            } 
            else if (tiers.BASE) {
                const baseLimit = tiers.BASE.max_distance_km || 2;
                if (distance <= baseLimit) price = tiers.BASE.delivery_fee;
                else price = tiers.MID.base_fee + ((distance - baseLimit) * tiers.MID.price_per_km);
            }

            price = Math.ceil(price / 500) * 500;
            window.APP.calc.price = price;
            
            // RENDER UI
            const fakePrice = Math.ceil((price * 1.25) / 1000) * 1000;
            document.getElementById('fake-price').innerText = `Rp ${fakePrice.toLocaleString('id-ID')}`;
            document.getElementById('price-display').innerText = `Rp ${price.toLocaleString('id-ID')}`;
            document.getElementById('dist-display').innerText = `${distance.toFixed(1)} km`;
            document.getElementById('price-card').style.display = 'flex';
            
            updateLink();
        }

        window.updateLink = function() {
            const btn = document.getElementById('btn-submit');
            const textBtn = document.getElementById('btn-text');
            const price = window.APP.calc.price;
            const originVal = document.getElementById('origin').value.trim();
            const destVal = document.getElementById('destination').value.trim();

            if (price === 0 || originVal === '' || destVal === '') {
                btn.classList.add('disabled');
                textBtn.innerText = "Isi Lokasi Dulu";
                return;
            }

            btn.classList.remove('disabled');
            textBtn.innerText = `GAS ORDER ‚Ä¢ Rp ${price.toLocaleString('id-ID')}`;

            const note = document.getElementById('note').value;
            const items = document.getElementById('items').value;
            const estPrice = document.getElementById('est-price').value;
            
            let serviceCode = 'OJK';
            if (window.APP.service === 'FOOD_MART') serviceCode = 'JST';
            if (window.APP.service === 'SEND') serviceCode = 'SND';

            const orderID = `${serviceCode}-${Math.random().toString(36).substr(2, 5).toUpperCase()}`;

            let msg = `Halo Kak! Order ${window.APP.service}\n` +
                      `================\n` +
                      `ID ORDER : ${orderID}\n` +
                      `----------------\n` +
                      `‚Ä¢ Jemput : ${document.getElementById('origin').value}\n` +
                      `‚Ä¢ Tujuan : ${document.getElementById('destination').value}\n`;

            if(note) msg += `‚Ä¢ Catatan : ${note}\n`;
            
            if (window.APP.service === 'FOOD_MART') {
                msg += `----------------\n` + 
                       `‚Ä¢ Item : ${items}\n` +
                       `‚Ä¢ Est. Harga Barang : Rp ${estPrice || 0}\n`;
            }

            msg += `----------------\n` +
                   `‚Ä¢ Jarak : ${window.APP.calc.distance} km\n` + 
                   `‚Ä¢ Ongkir : Rp ${price.toLocaleString('id-ID')}\n` +
                   `================\n` +
                   `Gas jemput?`;

            btn.href = `https://wa.me/${CONFIG_WA}?text=${encodeURIComponent(msg)}`;

            // Save History
            if (window.APP.places.origin && window.APP.places.dest) {
                localStorage.setItem('bantujeg_history', JSON.stringify({
                    origin_addr: originVal,
                    origin_loc: window.APP.places.origin.geometry.location,
                    dest_addr: destVal,
                    dest_loc: window.APP.places.dest.geometry.location,
                    note: note
                }));
            }
        };

        // --- UTILS ---
        window.setService = function(type, el) {
            window.APP.service = type;
            
            // Visual Tab Active
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            if(el) el.classList.add('active');
            else document.querySelector('.tab').classList.add('active');

            // === TAB ISOLATION (RESET EVERYTHING) ===
            document.getElementById('origin').value = '';
            document.getElementById('destination').value = '';
            document.getElementById('note').value = '';
            document.getElementById('items').value = '';
            document.getElementById('est-price').value = '';
            
            // Reset State & Map
            window.APP.places = { origin: null, dest: null };
            window.APP.calc = { distance: 0, price: 0 };
            
            // Reset UI Components
            document.getElementById('price-card').style.display = 'none';
            toggleClearBtn('origin');
            toggleClearBtn('destination');
            toggleClearBtn('note');
            
            const jastipField = document.getElementById('jastip-field');
            const legalWarning = document.getElementById('legal-warning');
            const originInput = document.getElementById('origin');
            const destInput = document.getElementById('destination');
            const gpsBtn = document.getElementById('btn-gps');
            const wrapOrg = document.getElementById('wrapper-origin');
            const wrapDst = document.getElementById('wrapper-destination');
            
            // Reset wrappers styling
            wrapOrg.classList.remove('has-gps');
            wrapDst.classList.remove('has-gps');

            // Hide Specifics
            jastipField.style.display = 'none';
            legalWarning.style.display = 'none';

            if (type === 'FOOD_MART') {
                jastipField.style.display = 'block';
                activateField('destination');
                
                // MOVE GPS TO DESTINATION
                wrapDst.appendChild(gpsBtn);
                wrapDst.classList.add('has-gps');

                originInput.placeholder = "Beli di mana? (Nama Warung/Toko)";
                destInput.placeholder = "Antar ke mana? (Lokasi Kamu)";
            } else if (type === 'SEND') {
                legalWarning.style.display = 'block';
                activateField('origin');
                
                // MOVE GPS TO ORIGIN
                wrapOrg.appendChild(gpsBtn);
                wrapOrg.classList.add('has-gps');

                originInput.placeholder = "Ambil paket di mana?";
                destInput.placeholder = "Kirim ke mana?";
            } else { // RIDE
                activateField('origin');
                
                // MOVE GPS TO ORIGIN
                wrapOrg.appendChild(gpsBtn);
                wrapOrg.classList.add('has-gps');

                originInput.placeholder = "Jemput di mana? (Cari Masjid/Sekolah)";
                destInput.placeholder = "Antar ke mana?";
            }
            
            // Force Button Reset
            updateLink();
        }

        function setLoading(state) {
            const spin = document.getElementById('loading-spin');
            const txt = document.getElementById('btn-text');
            if (state) {
                spin.style.display = 'block';
                txt.style.display = 'none';
            } else {
                spin.style.display = 'none';
                txt.style.display = 'block';
            }
        }

        window.handleInput = function(id) {
            toggleClearBtn(id);
            if (document.getElementById(id).value.trim() === '') {
                window.APP.calc.price = 0;
                document.getElementById('price-card').style.display = 'none';
                updateLink();
            }
        };

        window.toggleClearBtn = function(id) {
            const input = document.getElementById(id);
            const btn = document.getElementById('clear-' + id);
            if(input.value.length > 0) btn.style.display = 'flex';
            else btn.style.display = 'none';
        };

        window.clearInput = function(id) {
            document.getElementById(id).value = '';
            toggleClearBtn(id);
            handleInput(id);
            document.getElementById(id).focus();
        };

        function cleanAddress(addr) {
            if(!addr) return "";
            return addr.replace(/^[A-Z0-9\+]{4,8}(\+[A-Z0-9]{2,})?,\s*/, '');
        }

        window.addNote = function(text) {
            const noteInput = document.getElementById('note');
            if (noteInput.value.length > 0) {
                noteInput.value += `, ${text}`;
            } else {
                noteInput.value = text;
            }
            updateLink();
            toggleClearBtn('note');
        };

        function checkHistory() {
            const stored = localStorage.getItem('bantujeg_history');
            if (stored) {
                try {
                    const data = JSON.parse(stored);
                    if(data.origin_addr && data.dest_addr) {
                        window.APP.historyData = data;
                        document.getElementById('history-text').innerText = `üïí ${cleanAddress(data.origin_addr)} ‚Üí ${cleanAddress(data.dest_addr)}`;
                        document.getElementById('history-chip').style.display = 'flex';
                    }
                } catch(e) {}
            }
        }

        window.useHistory = function() {
            const data = window.APP.historyData;
            if(!data) return;
            document.getElementById('history-chip').style.display = 'none';
            document.getElementById('origin').value = data.origin_addr;
            document.getElementById('destination').value = data.dest_addr;
            if(data.note) document.getElementById('note').value = data.note;
            
            // Mock Geometry objects for calc
            window.APP.places.origin = { geometry: { location: data.origin_loc } };
            window.APP.places.dest = { geometry: { location: data.dest_loc } };
            
            calculateRoute();
            
            // Set Origin as active and pan
            activateField('origin');
            window.APP.map.setCenter(data.origin_loc);
            window.APP.map.setZoom(15);
        };

        // --- INJECT SCRIPT DYNAMICALLY (FIX SCOPE ISSUE) ---
        // This ensures initMap is defined BEFORE Maps API loads
        const script = document.createElement('script');
        script.src = "https://maps.googleapis.com/maps/api/js?key=AIzaSyAXo3ErccnWYzKPXZsli1j9zsE5_50hO1g&libraries=places,geometry&callback=initMap";
        script.async = true;
        script.defer = true;
        document.body.appendChild(script);

    </script>
</body>
</html>
