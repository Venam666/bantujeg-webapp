<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#ffffff">
    <title>BantuJeg - Order Cepat</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        :root { 
            --primary: #10B981; 
            --primary-dark: #059669;
            --danger: #EF4444;
            --dark: #0F172A; 
            --gray: #F8FAFC; 
            --border: #E2E8F0;
            --text-mute: #64748B;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: #ffffff; color: var(--dark); height: 100vh; overflow: hidden; display: flex; flex-direction: column; }

        /* --- LAYOUT --- */
        header { 
            padding: 16px 20px; background: white; z-index: 50; border-bottom: 1px solid #f1f1f1;
            display: flex; justify-content: space-between; align-items: center; flex-shrink: 0;
        }
        .brand-name { font-size: 1.25rem; font-weight: 800; color: var(--primary); line-height: 1.1; }
        .greeting { font-size: 0.8rem; color: var(--text-mute); font-weight: 600; }
        .pulse { width: 10px; height: 10px; background: var(--primary); border-radius: 50%; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.4); } 70% { box-shadow: 0 0 0 6px rgba(16, 185, 129, 0); } 100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0); } }

        /* MAP ENGINE */
        #map-wrapper {
            position: relative;
            width: 100%;
            height: 45vh;
            background: #eee;
            flex-shrink: 0;
        }
        #map { width: 100%; height: 100%; }

        /* UI ENGINE */
        .card-interface {
            flex: 1;
            background: white;
            padding: 24px 20px;
            border-radius: 24px 24px 0 0;
            margin-top: -24px;
            position: relative;
            z-index: 20;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.05);
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        /* TABS */
        .tabs { display: flex; gap: 8px; margin-bottom: 20px; background: var(--gray); padding: 4px; border-radius: 16px; border: 1px solid var(--border); flex-shrink: 0; }
        .tab { flex: 1; padding: 10px; text-align: center; border-radius: 12px; font-weight: 700; font-size: 0.85rem; color: var(--text-mute); cursor: pointer; transition: all 0.2s; }
        .tab.active { background: var(--primary); color: white; box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3); transform: scale(1.02); }

        /* INPUTS */
        .input-group { margin-bottom: 12px; }
        .input-wrapper { 
            position: relative; width: 100%; transition: all 0.3s; 
            border-radius: 16px; border: 1px solid transparent; background: var(--gray);
            display: flex; align-items: center; padding: 0 12px;
        }
        .input-wrapper.active { border-color: var(--primary); background: #F0FDF4; }
        
        .input-icon { font-size: 1.1rem; color: var(--text-mute); margin-right: 8px; flex-shrink: 0; }
        
        input, textarea { 
            width: 100%; padding: 14px 0; background: transparent; border: none;
            font-family: inherit; font-size: 0.9rem; color: var(--dark); outline: none; flex-grow: 1;
        }
        
        /* ACTION BUTTONS IN INPUT */
        .action-btn {
            width: 28px; height: 28px; border-radius: 50%; background: #E2E8F0;
            color: var(--text-mute); display: flex; align-items: center; justify-content: center;
            font-size: 12px; font-weight: bold; cursor: pointer; margin-left: 8px; flex-shrink: 0;
            visibility: hidden; /* Hidden by default */
        }
        .action-btn.visible { visibility: visible; }
        
        .gps-btn {
            background: white; border: 1px solid var(--border); color: var(--primary);
            padding: 6px 12px; border-radius: 12px; font-size: 0.75rem; font-weight: 700;
            cursor: pointer; margin-left: 8px; flex-shrink: 0; box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            display: flex; align-items: center; gap: 4px;
        }
        .gps-btn:active { transform: scale(0.95); }

        /* PRICE CARD */
        #price-card {
            background: linear-gradient(135deg, #0F172A 0%, #334155 100%);
            color: white; padding: 16px; border-radius: 16px;
            display: flex; align-items: center; justify-content: space-between;
            margin-top: auto; margin-bottom: 80px; /* Space for fixed bottom button */
            opacity: 0; transform: translateY(10px); transition: all 0.3s ease;
            pointer-events: none;
        }
        #price-card.visible { opacity: 1; transform: translateY(0); pointer-events: auto; }
        
        .fake-price { font-size: 0.75rem; text-decoration: line-through; color: #94A3B8; }
        .price-main { font-size: 1.5rem; font-weight: 800; }
        .price-dist { font-size: 0.8rem; opacity: 0.8; }

        /* ERROR CARD */
        #error-card {
            background: #FEF2F2; color: var(--danger); border: 1px solid #FECACA;
            padding: 12px; border-radius: 12px; margin-top: 10px; font-size: 0.85rem; font-weight: 600;
            text-align: center; display: none;
        }

        /* BOTTOM BAR */
        .bottom-bar { 
            background: white; padding: 16px 20px; border-top: 1px solid #eee; 
            position: fixed; bottom: 0; left: 0; width: 100%; z-index: 100;
        }
        .btn-cta {
            display: flex; justify-content: center; align-items: center; width: 100%;
            background: var(--primary); color: white; padding: 16px; border-radius: 16px;
            font-weight: 700; font-size: 1.1rem; text-decoration: none;
            transition: all 0.2s; box-shadow: 0 10px 20px rgba(16, 185, 129, 0.3);
            border: none; cursor: pointer;
        }
        .btn-cta:disabled { background: #cbd5e1; box-shadow: none; cursor: not-allowed; opacity: 0.7; }
        .btn-cta:active:not(:disabled) { transform: scale(0.98); }

        .spinner { border: 3px solid rgba(255,255,255,0.3); border-radius: 50%; border-top: 3px solid white; width: 20px; height: 20px; animation: spin 1s linear infinite; display: none; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* LOADING OVERLAY */
        #app-loader {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: white; z-index: 9999; display: flex; justify-content: center; align-items: center;
            flex-direction: column; gap: 10px; transition: opacity 0.5s;
        }
        .loader-text { font-weight: 700; color: var(--primary); font-size: 1.2rem; }

    </style>
</head>
<body>

    <!-- APP LOADER -->
    <div id="app-loader">
        <div class="loader-text">BantuJeg.</div>
        <div style="font-size:0.8rem; color:#64748b;">Memuat Sistem...</div>
    </div>

    <header>
        <div class="brand-container">
            <div class="brand-name">BantuJeg.</div>
            <div class="greeting">Siap Antar Kamu! üëã</div>
        </div>
        <div class="pulse"></div> 
    </header>

    <!-- MAP ENGINE VISUAL -->
    <div id="map-wrapper">
        <div id="map"></div>
    </div>

    <!-- UI ENGINE -->
    <div class="card-interface">
        
        <!-- TABS -->
        <div class="tabs">
            <div class="tab active" data-service="RIDE" onclick="APP.handlers.switchTab('RIDE')">üõµ OJEK</div>
            <div class="tab" data-service="SEND" onclick="APP.handlers.switchTab('SEND')">üì¶ SEND</div>
            <div class="tab" data-service="FOOD" onclick="APP.handlers.switchTab('FOOD')">üçú FOOD</div>
        </div>

        <!-- ORIGIN INPUT -->
        <div class="input-group">
            <div class="input-wrapper" id="wrap-origin">
                <span class="input-icon">üìç</span>
                <input type="text" id="input-origin" placeholder="Jemput di mana?">
                <div class="action-btn" id="clear-origin" onclick="APP.handlers.clearInput('origin')">‚úï</div>
                <div class="gps-btn" id="gps-origin" onclick="APP.handlers.useGPS('origin')">üìç Saya</div>
            </div>
        </div>

        <!-- DESTINATION INPUT -->
        <div class="input-group">
            <div class="input-wrapper" id="wrap-dest">
                <span class="input-icon">üèÅ</span>
                <input type="text" id="input-dest" placeholder="Antar ke mana?">
                <div class="action-btn" id="clear-dest" onclick="APP.handlers.clearInput('destination')">‚úï</div>
                <div class="gps-btn" id="gps-dest" onclick="APP.handlers.useGPS('destination')" style="display:none;">üìç Saya</div>
            </div>
        </div>

        <!-- NOTES (Optional) -->
        <div class="input-group">
            <div class="input-wrapper">
                <span class="input-icon">üìù</span>
                <input type="text" id="input-note" placeholder="Catatan untuk driver...">
            </div>
        </div>

        <!-- EXTRA FIELDS (Food/Send) -->
        <div id="extra-fields" style="display:none;">
            <div class="input-group">
                <div class="input-wrapper">
                    <span class="input-icon">üì¶</span>
                    <input type="text" id="input-details" placeholder="Detail barang / pesanan...">
                </div>
            </div>
        </div>

        <!-- ERROR STATE -->
        <div id="error-card"></div>

        <!-- PRICE CARD -->
        <div id="price-card">
            <div>
                <div class="price-dist" id="ui-dist">0 km</div>
                <div class="fake-price" id="ui-fake-price">Rp 0</div>
                <div class="price-main" id="ui-price">Rp 0</div>
            </div>
            <div style="text-align: right; font-size: 0.7rem; opacity: 0.8;">
                Tarif Final
            </div>
        </div>
    </div>

    <!-- CTA -->
    <div class="bottom-bar">
        <button id="btn-order" class="btn-cta" disabled onclick="APP.handlers.submitOrder()">
            <span id="btn-text">Lengkapi Data</span>
            <div class="spinner" id="btn-spin"></div>
        </button>
    </div>

    <!-- MODULES -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- GLOBAL APP ARCHITECTURE ---
        window.APP = {
            // 1. STATE ENGINE (Source of Truth)
            state: {
                origin: null,       // { lat, lng, address }
                destination: null,  // { lat, lng, address }
                distanceKm: 0,
                price: 0,
                service: "RIDE",    // RIDE, SEND, FOOD
                config: null,       // Loaded from Firebase
                isReady: false
            },

            // 2. ENGINES & OBJECTS
            map: null,
            directionsService: null,
            directionsRenderer: null,
            geocoder: null,
            markers: { origin: null, dest: null },
            
            // 3. ACTIONS (State Mutators)
            actions: {
                setOrigin: (place) => {
                    APP.state.origin = place;
                    APP.engines.ui.updateInput('input-origin', place ? place.address : '');
                    APP.engines.map.render();
                    APP.engines.route.compute();
                },
                setDestination: (place) => {
                    APP.state.destination = place;
                    APP.engines.ui.updateInput('input-dest', place ? place.address : '');
                    APP.engines.map.render();
                    APP.engines.route.compute();
                },
                setService: (type) => {
                    APP.state.service = type;
                    // Reset Trip Logic on Tab Switch
                    APP.state.origin = null;
                    APP.state.destination = null;
                    APP.state.distanceKm = 0;
                    APP.state.price = 0;
                    
                    APP.engines.ui.resetForm();
                    APP.engines.map.clear();
                    APP.engines.ui.renderTabs();
                },
                setConfig: (data) => {
                    APP.state.config = data;
                    APP.state.isReady = true;
                    document.getElementById('app-loader').style.display = 'none';
                }
            },

            // 4. HANDLERS (DOM Events)
            handlers: {
                switchTab: (type) => APP.actions.setService(type),
                clearInput: (type) => {
                    if (type === 'origin') APP.actions.setOrigin(null);
                    if (type === 'destination') APP.actions.setDestination(null);
                },
                useGPS: (type) => APP.engines.gps.locate(type),
                submitOrder: () => {
                    const { service, origin, destination, price, distanceKm } = APP.state;
                    if (!origin || !destination || !price) return;
                    
                    const note = document.getElementById('input-note').value;
                    const details = document.getElementById('input-details').value;
                    const waNum = "62895330091464";
                    
                    // Generate ID
                    const oid = `${service.substr(0,1)}-${Math.random().toString(36).substr(2,5).toUpperCase()}`;
                    
                    let msg = `*ORDER BARU ${service}*\nID: ${oid}\n----------------\n`;
                    msg += `üìç Jemput: ${origin.address}\n`;
                    msg += `üèÅ Tujuan: ${destination.address}\n`;
                    if(note) msg += `üìù Catatan: ${note}\n`;
                    if(details) msg += `üì¶ Detail: ${details}\n`;
                    msg += `----------------\n`;
                    msg += `üìè Jarak: ${distanceKm} km\n`;
                    msg += `üí∞ Ongkir: Rp ${price.toLocaleString('id-ID')}\n`;
                    msg += `----------------\nGas Jemput?`;

                    window.location.href = `https://wa.me/${waNum}?text=${encodeURIComponent(msg)}`;
                }
            },

            // 5. ENGINES
            engines: {
                // VISUAL ONLY
                map: {
                    init: () => {
                        const salatiga = { lat: -7.3305, lng: 110.5084 };
                        APP.map = new google.maps.Map(document.getElementById("map"), {
                            center: salatiga, zoom: 14, disableDefaultUI: true, clickableIcons: false
                        });
                        APP.directionsService = new google.maps.DirectionsService();
                        APP.directionsRenderer = new google.maps.DirectionsRenderer({
                            map: APP.map, suppressMarkers: true, // We use custom markers
                            polylineOptions: { strokeColor: "#10B981", strokeWeight: 5 }
                        });
                        APP.geocoder = new google.maps.Geocoder();
                    },
                    render: () => {
                        // Handle Origin Marker (Green)
                        if (APP.state.origin) {
                            if (!APP.markers.origin) {
                                APP.markers.origin = new google.maps.Marker({
                                    position: APP.state.origin, map: APP.map,
                                    icon: { url: "http://maps.google.com/mapfiles/ms/icons/green-dot.png" },
                                    animation: google.maps.Animation.DROP
                                });
                            } else {
                                APP.markers.origin.setPosition(APP.state.origin);
                            }
                        } else if (APP.markers.origin) {
                            APP.markers.origin.setMap(null);
                            APP.markers.origin = null;
                        }

                        // Handle Dest Marker (Red)
                        if (APP.state.destination) {
                            if (!APP.markers.dest) {
                                APP.markers.dest = new google.maps.Marker({
                                    position: APP.state.destination, map: APP.map,
                                    icon: { url: "http://maps.google.com/mapfiles/ms/icons/red-dot.png" },
                                    animation: google.maps.Animation.DROP
                                });
                            } else {
                                APP.markers.dest.setPosition(APP.state.destination);
                            }
                        } else if (APP.markers.dest) {
                            APP.markers.dest.setMap(null);
                            APP.markers.dest = null;
                        }

                        // Bounds Logic
                        const bounds = new google.maps.LatLngBounds();
                        if (APP.state.origin) bounds.extend(APP.state.origin);
                        if (APP.state.destination) bounds.extend(APP.state.destination);
                        
                        if (!bounds.isEmpty()) {
                            APP.map.fitBounds(bounds, { padding: 50 });
                            if (!APP.state.destination && APP.state.origin) APP.map.setZoom(16);
                        }
                    },
                    clear: () => {
                        if (APP.markers.origin) APP.markers.origin.setMap(null);
                        if (APP.markers.dest) APP.markers.dest.setMap(null);
                        APP.markers = { origin: null, dest: null };
                        APP.directionsRenderer.setDirections({ routes: [] });
                        APP.map.setCenter({ lat: -7.3305, lng: 110.5084 });
                        APP.map.setZoom(14);
                    }
                },

                // LOGIC ONLY
                route: {
                    compute: () => {
                        const { origin, destination } = APP.state;
                        // Reset if either missing
                        if (!origin || !destination) {
                            APP.state.distanceKm = 0;
                            APP.state.price = 0;
                            APP.directionsRenderer.setDirections({ routes: [] });
                            APP.engines.ui.renderPrice();
                            return;
                        }

                        APP.directionsService.route({
                            origin: origin, destination: destination,
                            travelMode: google.maps.TravelMode.TWO_WHEELER
                        }, (res, status) => {
                            if (status === "OK") {
                                APP.directionsRenderer.setDirections(res);
                                const distMeters = res.routes[0].legs[0].distance.value;
                                const distKm = parseFloat((distMeters / 1000).toFixed(2));
                                
                                APP.state.distanceKm = distKm;
                                APP.engines.pricing.compute();
                            } else {
                                APP.engines.ui.showError("Gagal menghitung rute.");
                            }
                        });
                    }
                },

                // CALCULATION ONLY
                pricing: {
                    compute: () => {
                        const { distanceKm, service, config } = APP.state;
                        if (!config) return;

                        const cfg = config[service]; // Get specific config
                        if (!cfg) return;

                        // Check Max Dist
                        if (distanceKm > 25) {
                            APP.engines.ui.showError("Kejauhan Boss! Max 25km.");
                            APP.state.price = 0;
                            APP.engines.ui.renderPrice();
                            return;
                        }

                        // Formula: Base + (Dist - BaseDist) * Rate
                        let p = 0;
                        if (distanceKm <= cfg.base_km) {
                            p = cfg.base_price;
                        } else {
                            const extra = distanceKm - cfg.base_km;
                            const blocks = Math.ceil(extra / cfg.block_size); // e.g., 0.2km blocks
                            p = cfg.base_price + (blocks * cfg.price_per_block);
                        }

                        // Round Up
                        p = Math.ceil(p / 500) * 500;
                        APP.state.price = p;
                        APP.engines.ui.renderPrice();
                    }
                },

                // RENDER ONLY
                ui: {
                    updateInput: (id, val) => {
                        document.getElementById(id).value = val;
                        // Toggle clear btn visibility
                        const wrapper = document.getElementById(id).parentElement;
                        const clearBtn = wrapper.querySelector('.action-btn');
                        if (clearBtn) clearBtn.classList.toggle('visible', val.length > 0);
                    },
                    resetForm: () => {
                        document.getElementById('input-origin').value = '';
                        document.getElementById('input-dest').value = '';
                        document.getElementById('input-note').value = '';
                        document.getElementById('input-details').value = '';
                        document.querySelectorAll('.action-btn').forEach(b => b.classList.remove('visible'));
                        APP.engines.ui.renderPrice();
                        document.getElementById('error-card').style.display = 'none';
                    },
                    renderTabs: () => {
                        const s = APP.state.service;
                        document.querySelectorAll('.tab').forEach(t => {
                            t.classList.toggle('active', t.dataset.service === s);
                        });
                        
                        // Toggle GPS Button Placement & Placeholders
                        const gpsOrigin = document.getElementById('gps-origin');
                        const gpsDest = document.getElementById('gps-dest');
                        const extraFields = document.getElementById('extra-fields');
                        const inOrigin = document.getElementById('input-origin');
                        
                        if (s === 'FOOD') {
                            gpsOrigin.style.display = 'none';
                            gpsDest.style.display = 'flex';
                            extraFields.style.display = 'block';
                            inOrigin.placeholder = "Beli di mana? (Nama Warung)";
                        } else {
                            gpsOrigin.style.display = 'flex';
                            gpsDest.style.display = 'none';
                            extraFields.style.display = (s === 'SEND') ? 'block' : 'none';
                            inOrigin.placeholder = (s === 'SEND') ? "Ambil paket di mana?" : "Jemput di mana?";
                        }
                    },
                    renderPrice: () => {
                        const card = document.getElementById('price-card');
                        const { price, distanceKm } = APP.state;
                        const btn = document.getElementById('btn-order');
                        const btnText = document.getElementById('btn-text');

                        if (price > 0) {
                            card.classList.add('visible');
                            document.getElementById('ui-price').innerText = "Rp " + price.toLocaleString('id-ID');
                            document.getElementById('ui-fake-price').innerText = "Rp " + (price * 1.2).toLocaleString('id-ID');
                            document.getElementById('ui-dist').innerText = distanceKm + " km";
                            
                            btn.disabled = false;
                            btnText.innerText = "GAS ORDER SEKARANG üöÄ";
                        } else {
                            card.classList.remove('visible');
                            btn.disabled = true;
                            btnText.innerText = "Lengkapi Data Dulu";
                        }
                        
                        // Hide error if price valid
                        if (price > 0) document.getElementById('error-card').style.display = 'none';
                    },
                    showError: (msg) => {
                        const err = document.getElementById('error-card');
                        err.innerText = msg;
                        err.style.display = 'block';
                    }
                },

                gps: {
                    locate: (type) => {
                        if (!navigator.geolocation) return alert("Browser tidak support GPS");
                        
                        // Show Loading in Input
                        const inputId = type === 'origin' ? 'input-origin' : 'input-dest';
                        document.getElementById(inputId).placeholder = "Mencari lokasi...";

                        navigator.geolocation.getCurrentPosition(pos => {
                            const lat = pos.coords.latitude;
                            const lng = pos.coords.longitude;
                            const latlng = { lat, lng };

                            // Reverse Geocode
                            APP.geocoder.geocode({ location: latlng }, (res, status) => {
                                if (status === "OK" && res[0]) {
                                    const place = {
                                        lat: lat, lng: lng,
                                        address: res[0].formatted_address.replace(/^[A-Z0-9\+]{4,8}(\+[A-Z0-9]{2,})?,\s*/, '') // Clean Plus Code
                                    };
                                    if (type === 'origin') APP.actions.setOrigin(place);
                                    else APP.actions.setDestination(place);
                                }
                            });
                        }, () => alert("Gagal ambil lokasi GPS"));
                    }
                }
            }
        };

        // --- INIT FIREBASE CONFIG ---
        const firebaseConfigData = {
            apiKey: "AIzaSyAekghf6Oydh17aYc_ia1zy3oNDsFK4aww",
            authDomain: "tanganbantu-poc.firebaseapp.com",
            projectId: "tanganbantu-poc",
            storageBucket: "tanganbantu-poc.firebasestorage.app",
            messagingSenderId: "236145821183",
            appId: "1:236145821183:web:c390d511bf9da9a86913ca"
        };

        // --- STARTUP SEQUENCE ---
        // 1. Initialize Google Maps (Callback)
        window.initMapCallback = function() {
            APP.engines.map.init();
            initAutocomplete();
        };

        // 2. Fetch Config
        const remoteConfig = {};
        async function startApp() {
            try {
                // Mock Config for Production Stability (Replace with real Fetch later)
                // We use local fallback to ensure 100% uptime if Firebase lags
                const defaultConfig = {
                    RIDE: { base_price: 6000, base_km: 2, price_per_block: 400, block_size: 0.2 },
                    SEND: { base_price: 7000, base_km: 2, price_per_block: 500, block_size: 0.2 },
                    FOOD: { base_price: 8000, base_km: 2, price_per_block: 500, block_size: 0.2 }
                };
                
                // Try fetch from Firestore
                // const docSnap = await getDoc(doc(db, "pricing", "CONFIG_V1"));
                // if(docSnap.exists()) APP.actions.setConfig(docSnap.data());
                // else APP.actions.setConfig(defaultConfig);
                
                // For MVP Speed: Use Default Direct
                APP.actions.setConfig(defaultConfig);

            } catch (e) {
                console.error("Init Error", e);
            }
        }
        startApp();

        // 3. Setup Autocomplete
        function initAutocomplete() {
            const opts = { componentRestrictions: { country: "id" }, fields: ["geometry", "formatted_address", "name"] };
            
            const acOrigin = new google.maps.places.Autocomplete(document.getElementById('input-origin'), opts);
            const acDest = new google.maps.places.Autocomplete(document.getElementById('input-dest'), opts);

            acOrigin.bindTo("bounds", APP.map);
            acDest.bindTo("bounds", APP.map);

            acOrigin.addListener("place_changed", () => {
                const place = acOrigin.getPlace();
                if (!place.geometry) return;
                APP.actions.setOrigin({
                    lat: place.geometry.location.lat(),
                    lng: place.geometry.location.lng(),
                    address: place.formatted_address.replace(/^[A-Z0-9\+]{4,8}(\+[A-Z0-9]{2,})?,\s*/, '')
                });
            });

            acDest.addListener("place_changed", () => {
                const place = acDest.getPlace();
                if (!place.geometry) return;
                APP.actions.setDestination({
                    lat: place.geometry.location.lat(),
                    lng: place.geometry.location.lng(),
                    address: place.formatted_address.replace(/^[A-Z0-9\+]{4,8}(\+[A-Z0-9]{2,})?,\s*/, '')
                });
            });
        }

        // --- SCRIPT LOADER ---
        const script = document.createElement('script');
        script.src = "https://maps.googleapis.com/maps/api/js?key=AIzaSyAXo3ErccnWYzKPXZsli1j9zsE5_50hO1g&libraries=places,geometry&callback=initMapCallback";
        script.async = true;
        document.body.appendChild(script);

    </script>
</body>
</html>
