<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#ffffff">
    <title>BantuJeg - Order Cepat</title>

    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap"
        rel="stylesheet">

    <style>
        :root {
            --primary: #10B981;
            --primary-dark: #059669;
            --danger: #EF4444;
            --warning-bg: #FEF9C3;
            --warning-text: #854D0E;
            --dark: #0F172A;
            --gray: #F8FAFC;
            --border: #E2E8F0;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background: #ffffff;
            color: var(--dark);
            padding-bottom: 100px;
        }

        header {
            padding: 12px 20px;
            background: white;
            position: sticky;
            top: 0;
            z-index: 50;
            border-bottom: 1px solid #f1f1f1;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .brand-name {
            font-size: 1.25rem;
            font-weight: 800;
            color: var(--primary);
            line-height: 1.1;
        }

        .greeting {
            font-size: 0.8rem;
            color: #64748B;
            font-weight: 600;
        }

        .pulse {
            width: 10px;
            height: 10px;
            background: #10B981;
            border-radius: 50%;
            animation: pulse 1.5s infinite;
            box-shadow: 0 0 0 rgba(16, 185, 129, 0.4);
        }

        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.4);
            }

            70% {
                box-shadow: 0 0 0 6px rgba(16, 185, 129, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(16, 185, 129, 0);
            }
        }

        /* MAP UI */
        #map-wrapper {
            padding: 20px 20px 0 20px;
            background: white;
        }

        #map-container {
            height: 280px;
            width: 100%;
            position: relative;
            background: #eee;
            border-radius: 24px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }

        #map {
            width: 100%;
            height: 100%;
        }

        .expand-icon {
            position: absolute;
            top: 12px;
            right: 12px;
            width: 36px;
            height: 36px;
            background: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
            z-index: 15;
        }

        #map-container.expanded {
            height: 65vh;
            border-radius: 0;
            box-shadow: none;
        }

        .map-tooltip {
            background: white;
            border-radius: 8px;
            padding: 6px 10px;
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--dark);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            border: none;
        }

        /* Google Maps Custom Tooltip */
        .gm-tooltip {
            background: white;
            border-radius: 8px;
            padding: 6px 10px;
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--dark);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            border: none;
            white-space: nowrap;
        }

        /* TAB SYSTEM */
        .tab-container {
            padding: 16px 20px 0;
            background: white;
        }

        .tab-nav {
            display: flex;
            gap: 8px;
            background: var(--gray);
            padding: 5px;
            border-radius: 16px;
            border: 1px solid var(--border);
        }

        .tab-btn {
            flex: 1;
            padding: 10px;
            text-align: center;
            background: transparent;
            border: none;
            font-size: 0.85rem;
            font-weight: 700;
            color: #94A3B8;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .tab-btn.active {
            background: var(--primary);
            color: white;
            box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);
        }

        /* INPUT CARD */
        .input-section {
            padding: 20px;
            background: white;
        }

        .input-wrapper {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 14px;
            background: var(--gray);
            border-radius: 16px;
            margin-bottom: 12px;
            transition: all 0.2s;
            border: 2px solid transparent;
        }

        .input-wrapper:focus-within {
            border-color: var(--primary);
            background: #F0FDF4;
        }

        .input-icon {
            font-size: 1.2rem;
        }

        input,
        textarea {
            flex: 1;
            border: none;
            background: transparent;
            font-family: inherit;
            font-size: 0.95rem;
            color: var(--dark);
            outline: none;
        }

        textarea {
            resize: none;
            min-height: 50px;
        }

        input::placeholder,
        textarea::placeholder {
            color: #94A3B8;
        }

        .gps-icon {
            cursor: pointer;
            padding: 6px 12px;
            background: white;
            border-radius: 10px;
            font-size: 0.75rem;
            font-weight: 700;
            color: var(--primary);
            border: 1px solid var(--border);
            transition: all 0.2s;
        }

        .gps-icon:active {
            transform: scale(0.95);
        }

        .clear-icon {
            cursor: pointer;
            width: 24px;
            height: 24px;
            background: #CBD5E1;
            border-radius: 50%;
            display: none;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: bold;
            color: #64748B;
        }

        /* HISTORY CHIP */
        .history-chip {
            background: #ECFDF5;
            border: 1px solid #A7F3D0;
            color: #065F46;
            padding: 12px 16px;
            border-radius: 12px;
            font-size: 0.85rem;
            font-weight: 600;
            margin-bottom: 16px;
            cursor: pointer;
            display: none;
            align-items: center;
            justify-content: space-between;
        }

        /* PRICE CARD */
        .price-card {
            background: linear-gradient(135deg, #F0FDF4, #D1FAE5);
            border: 2px solid var(--primary);
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 16px;
            display: none;
        }

        .price-dist {
            font-size: 0.8rem;
            color: #065F46;
            margin-bottom: 4px;
            font-weight: 600;
        }

        .fake-price {
            font-size: 0.9rem;
            color: #94A3B8;
            text-decoration: line-through;
            margin-bottom: 4px;
        }

        .price-main {
            font-size: 1.5rem;
            font-weight: 800;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .promo-tag {
            font-size: 0.75rem;
            background: #FDE047;
            color: #854D0E;
            padding: 4px 8px;
            border-radius: 6px;
        }

        /* ERROR CARD */
        .error-card {
            background: #FEE2E2;
            border: 2px solid var(--danger);
            color: #991B1B;
            padding: 14px;
            border-radius: 12px;
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 16px;
            display: none;
        }

        /* JASTIP FIELDS */
        .jastip-fields {
            display: none;
        }

        /* BOTTOM BAR */
        .bottom-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 16px 20px;
            background: white;
            border-top: 1px solid var(--border);
            z-index: 40;
        }

        .btn-cta {
            width: 100%;
            padding: 16px;
            background: var(--primary);
            color: white;
            text-align: center;
            border-radius: 14px;
            font-size: 1rem;
            font-weight: 700;
            text-decoration: none;
            display: block;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
            transition: all 0.2s;
        }

        .btn-cta.disabled {
            background: #CBD5E1;
            color: #94A3B8;
            pointer-events: none;
        }

        .spinner {
            width: 18px;
            height: 18px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.6s linear infinite;
            display: none;
            margin: 0 auto;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body>
    <header>
        <div class="brand-name">BantuJeg</div>
        <div style="display: flex; align-items: center; gap: 8px;">
            <div class="pulse"></div>
            <div class="greeting">Ready</div>
        </div>
    </header>

    <div id="map-wrapper">
        <div id="map-container">
            <div id="map"></div>
            <div class="expand-icon" onclick="expandMap()">‚õ∂</div>
        </div>
    </div>

    <div class="tab-container">
        <div class="tab-nav">
            <button class="tab-btn active" onclick="setService('RIDE', this)">üèçÔ∏è Ride</button>
            <button class="tab-btn" onclick="setService('SEND', this)">üì¶ Send</button>
            <button class="tab-btn" onclick="setService('FOOD_MART', this)">üõí Food/Mart</button>
        </div>
    </div>

    <div class="input-section">
        <div class="history-chip" id="history-chip" onclick="useHistory()">
            <span id="history-text"></span>
            <span>‚Ü©Ô∏è</span>
        </div>

        <!-- ORIGIN INPUT -->
        <div class="input-wrapper" id="wrapper-origin">
            <span class="input-icon">üìç</span>
            <input type="text" id="origin" placeholder="Jemput di mana? (Cari Masjid/Sekolah)"
                oninput="handleInput('origin')">
            <span class="gps-icon" onclick="getCurrentLocation()">üìç GPS</span>
            <span class="clear-icon" id="clear-origin" onclick="clearInput('origin')">√ó</span>
        </div>

        <!-- DESTINATION INPUT -->
        <div class="input-wrapper" id="wrapper-destination">
            <span class="input-icon">üèÅ</span>
            <input type="text" id="destination" placeholder="Antar ke mana?" oninput="handleInput('destination')">
            <span class="clear-icon" id="clear-destination" onclick="clearInput('destination')">√ó</span>
        </div>

        <!-- NOTES INPUT -->
        <div class="input-wrapper">
            <span class="input-icon">üí¨</span>
            <textarea id="note" placeholder="Catatan tambahan (opsional)" oninput="handleInput('note')"></textarea>
            <span class="clear-icon" id="clear-note" onclick="clearInput('note')">√ó</span>
        </div>

        <!-- JASTIP FIELDS (FOOD/MART ONLY) -->
        <div class="jastip-fields" id="jastip-fields">
            <div class="input-wrapper">
                <span class="input-icon">üìù</span>
                <input type="text" id="items" placeholder="Item apa yang mau dibeli?" oninput="updateLink()">
            </div>
            <div class="input-wrapper">
                <span class="input-icon">üí∞</span>
                <input type="number" id="est-price" placeholder="Estimasi harga barang (Rp)" oninput="updateLink()">
            </div>
        </div>

        <!-- ERROR MESSAGE -->
        <div class="error-card" id="error-card">
            ‚úã Kejauhan Boss! Max 25km ya.
        </div>

        <!-- PRICE DISPLAY (HARGA CORET) -->
        <div class="price-card" id="price-card">
            <div>
                <div class="price-dist" id="dist-display">0 km</div>
                <div class="fake-price" id="fake-price">Rp 0</div>
                <div class="price-main">
                    <span id="price-display">Rp 0</span>
                    <span class="promo-tag">‚ö° Promo</span>
                </div>
            </div>
            <div style="text-align: right; font-size: 0.8rem; opacity: 0.7;">
                Tarif Resmi<br>BantuJeg
            </div>
        </div>
    </div>

    <div class="bottom-bar">
        <a id="btn-submit" href="#" class="btn-cta disabled">
            <span id="btn-text">Isi Lokasi Dulu</span>
            <div class="spinner" id="loading-spin"></div>
        </a>
    </div>

    <script>
        window.APP = {
            service: 'RIDE',
            config: { RIDE: null, FOOD_MART: null, SEND: null },
            places: { origin: null, dest: null },
            calc: { distance: 0, price: 0 },
            map: null,
            markers: { origin: null, dest: null },
            infoWindows: { origin: null, dest: null },
            historyData: null
        };
    </script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAekghf6Oydh17aYc_ia1zy3oNDsFK4aww",
            authDomain: "tanganbantu-poc.firebaseapp.com",
            projectId: "tanganbantu-poc",
            storageBucket: "tanganbantu-poc.firebasestorage.app",
            messagingSenderId: "236145821183",
            appId: "1:236145821183:web:c390d511bf9da9a86913ca"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        async function loadConfigs() {
            try {
                const [rideSnap, foodSnap, sendSnap] = await Promise.all([
                    getDoc(doc(db, 'pricing_configs', 'RIDE_v1')),
                    getDoc(doc(db, 'pricing_configs', 'FOOD_MART_v1')),
                    getDoc(doc(db, 'pricing_configs', 'SEND_v1'))
                ]);

                if (rideSnap.exists()) window.APP.config.RIDE = rideSnap.data();
                if (foodSnap.exists()) window.APP.config.FOOD_MART = foodSnap.data();
                if (sendSnap.exists()) window.APP.config.SEND = sendSnap.data();
                console.log("‚úÖ CONFIG LOADED");
            } catch (e) {
                console.error("‚ùå Config Error:", e);
            }
        }
        loadConfigs();
    </script>

    <script>
        const CONFIG_WA = "62895330091464";

        function initMap() {
            // Initialize Google Maps
            window.APP.map = new google.maps.Map(document.getElementById('map'), {
                center: { lat: -7.3305, lng: 110.5084 }, // Salatiga area
                zoom: 14,
                minZoom: 10,
                disableDefaultUI: true,
                zoomControl: true,
                gestureHandling: 'greedy',
                styles: [
                    {
                        featureType: 'poi.business',
                        stylers: [{ visibility: 'off' }]
                    }
                ]
            });

            initAutocomplete();
            checkHistory();
        }

        // --- HISTORY FEATURE ---
        function checkHistory() {
            const stored = localStorage.getItem('bantujeg_history');
            if (stored) {
                try {
                    const data = JSON.parse(stored);
                    if (data && data.origin_addr && data.dest_addr) {
                        window.APP.historyData = data;
                        const chip = document.getElementById('history-chip');
                        document.getElementById('history-text').innerText = `üïí Pakai Rute Terakhir: ${cleanAddress(data.origin_addr)} ‚Üí ${cleanAddress(data.dest_addr)}`;
                        chip.style.display = 'flex';
                    }
                } catch (e) { console.error(e); }
            }
        }

        window.useHistory = function () {
            const data = window.APP.historyData;
            if (!data) return;

            // Hide chip
            document.getElementById('history-chip').style.display = 'none';

            // Populate Fields
            document.getElementById('origin').value = data.origin_addr;
            document.getElementById('destination').value = data.dest_addr;
            if (data.note) document.getElementById('note').value = data.note;

            // Reconstruct Place Objects (Mock for calculation)
            window.APP.places.origin = {
                geometry: { location: { lat: () => data.origin_lat, lng: () => data.origin_lng } },
                formatted_address: data.origin_addr
            };
            window.APP.places.dest = {
                geometry: { location: { lat: () => data.dest_lat, lng: () => data.dest_lng } },
                formatted_address: data.dest_addr
            };

            // Trigger Map Update
            updateMarker('origin', data.origin_lat, data.origin_lng);
            updateMarker('dest', data.dest_lat, data.dest_lng);
            expandMap();
            calculateRoute();
            toggleClearBtn('origin');
            toggleClearBtn('destination');
        }

        // --- QUICK NOTE FEATURE ---
        window.addNote = function (text) {
            const noteInput = document.getElementById('note');
            if (noteInput.value.length > 0) {
                noteInput.value += `, ${text}`;
            } else {
                noteInput.value = text;
            }
            updateLink();
            toggleClearBtn('note');
        }

        // --- HELPER: CLEAN ADDRESS ---
        function cleanAddress(address) {
            if (!address) return "";
            return address.replace(/^[A-Z0-9\+]{4,8}(\+[A-Z0-9]{2,})?,\s*/, '');
        }

        // --- UI: INPUT HANDLERS ---
        window.handleInput = function (id) {
            toggleClearBtn(id);
            // VALIDASI: Kalau user hapus teks, reset harga & button
            const val = document.getElementById(id).value;
            if (val.trim() === '') {
                // Determine which type it is
                if (id === 'origin' || id === 'destination') {
                    const type = id === 'origin' ? 'origin' : 'dest';
                    window.APP.places[type] = null;
                    if (window.APP.markers[type]) {
                        window.APP.markers[type].setMap(null);
                        window.APP.markers[type] = null;
                    }
                    if (window.APP.infoWindows[type]) {
                        window.APP.infoWindows[type].close();
                        window.APP.infoWindows[type] = null;
                    }
                    window.APP.calc.price = 0;
                    document.getElementById('price-card').style.display = 'none';
                    updateLink();
                }
            }
        }

        window.toggleClearBtn = function (id) {
            const input = document.getElementById(id);
            const btn = document.getElementById('clear-' + id);
            if (input.value.length > 0) btn.style.display = 'flex';
            else btn.style.display = 'none';
        }

        window.clearInput = function (id) {
            const input = document.getElementById(id);
            input.value = '';
            toggleClearBtn(id);

            if (id === 'origin' || id === 'destination') {
                const type = id === 'origin' ? 'origin' : 'dest';
                window.APP.places[type] = null;
                if (window.APP.markers[type]) {
                    window.APP.markers[type].setMap(null);
                    window.APP.markers[type] = null;
                }
                if (window.APP.infoWindows[type]) {
                    window.APP.infoWindows[type].close();
                    window.APP.infoWindows[type] = null;
                }
                window.APP.calc.price = 0; // Reset Price
                document.getElementById('price-card').style.display = 'none';
                document.getElementById('error-card').style.display = 'none';
                updateLink(); // Update Button State
            }
        }

        function updateMarker(type, lat, lng) {
            const map = window.APP.map;
            const markers = window.APP.markers;
            const infoWindows = window.APP.infoWindows;

            const iconUrl = type === 'origin'
                ? 'https://cdn-icons-png.flaticon.com/512/684/684908.png'
                : 'https://cdn-icons-png.flaticon.com/512/684/684913.png';

            // Remove existing marker
            if (markers[type]) {
                markers[type].setMap(null);
            }
            if (infoWindows[type]) {
                infoWindows[type].close();
            }

            // Create new marker
            markers[type] = new google.maps.Marker({
                position: { lat: lat, lng: lng },
                map: map,
                icon: {
                    url: iconUrl,
                    scaledSize: new google.maps.Size(36, 36),
                    anchor: new google.maps.Point(18, 36)
                },
                animation: google.maps.Animation.DROP
            });

            // Create InfoWindow for label
            const label = type === 'origin' ? "üìç Titik Jemput" : "üèÅ Tujuan";
            infoWindows[type] = new google.maps.InfoWindow({
                content: `<div class="gm-tooltip">${label}</div>`,
                disableAutoPan: true
            });
            infoWindows[type].open(map, markers[type]);

            // Fit bounds if both markers exist
            if (markers.origin && markers.dest) {
                const bounds = new google.maps.LatLngBounds();
                bounds.extend(markers.origin.getPosition());
                bounds.extend(markers.dest.getPosition());
                map.fitBounds(bounds);
                
                // Add padding
                google.maps.event.addListenerOnce(map, 'bounds_changed', function() {
                    const zoom = map.getZoom();
                    if (zoom > 16) map.setZoom(16);
                });
            } else {
                map.setCenter({ lat: lat, lng: lng });
                map.setZoom(16);
            }
        }

        function getCurrentLocation() {
            if (!navigator.geolocation) { alert("Browser tidak support GPS"); return; }

            const btnText = document.querySelector('.gps-icon');
            const originalText = btnText.innerHTML;
            btnText.innerHTML = "‚è≥...";

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    const latlng = { lat: lat, lng: lng };

                    const geocoder = new google.maps.Geocoder();
                    geocoder.geocode({ location: latlng }, (results, status) => {
                        btnText.innerHTML = originalText;
                        if (status === "OK" && results[0]) {
                            const rawAddr = results[0].formatted_address;
                            const cleaned = cleanAddress(rawAddr);

                            const isOrigin = btnText.parentElement.id === 'wrapper-origin';
                            const inputId = isOrigin ? 'origin' : 'destination';
                            const type = isOrigin ? 'origin' : 'dest';

                            document.getElementById(inputId).value = cleaned;
                            toggleClearBtn(inputId);

                            window.APP.places[type] = results[0];
                            updateMarker(type, lat, lng);
                            expandMap();

                            if (window.APP.places.origin && window.APP.places.dest) calculateRoute();
                        } else {
                            alert("Gagal mendeteksi nama jalan.");
                        }
                    });
                },
                (error) => {
                    btnText.innerHTML = originalText;
                    alert("Gagal ambil lokasi. Pastikan GPS nyala!");
                }
            );
        }

        function initAutocomplete() {
            const options = {
                bounds: new google.maps.LatLngBounds(
                    new google.maps.LatLng(-7.60, 110.23),
                    new google.maps.LatLng(-7.06, 110.77)
                ),
                componentRestrictions: { country: "id" },
                fields: ["geometry", "name", "formatted_address"],
                strictBounds: true
            };

            const acOrigin = new google.maps.places.Autocomplete(document.getElementById('origin'), options);
            const acDest = new google.maps.places.Autocomplete(document.getElementById('destination'), options);

            acOrigin.addListener('place_changed', () => handlePlaceSelect('origin', acOrigin));
            acDest.addListener('place_changed', () => handlePlaceSelect('dest', acDest));
        }

        function handlePlaceSelect(type, ac) {
            const place = ac.getPlace();
            if (!place.geometry) return;

            const inputId = type === 'origin' ? 'origin' : 'destination';
            const cleaned = cleanAddress(place.formatted_address);
            document.getElementById(inputId).value = cleaned;
            toggleClearBtn(inputId);

            window.APP.places[type] = place;
            updateMarker(type, place.geometry.location.lat(), place.geometry.location.lng());
            calculateRoute();
        }

        function calculateRoute() {
            const { origin, dest } = window.APP.places;
            const originVal = document.getElementById('origin').value.trim();
            const destVal = document.getElementById('destination').value.trim();

            // VALIDASI: Cek text kosong walaupun object place ada
            if (!origin || !dest || originVal === '' || destVal === '') {
                window.APP.calc.price = 0;
                updateLink();
                return;
            }

            setLoading(true);
            document.getElementById('error-card').style.display = 'none';

            const directionsService = new google.maps.DirectionsService();
            directionsService.route({
                origin: origin.geometry.location,
                destination: dest.geometry.location,
                travelMode: google.maps.TravelMode.TWO_WHEELER,
                avoidTolls: true
            }, (res, status) => {
                setLoading(false);
                if (status === 'OK') {
                    const googleKm = res.routes[0].legs[0].distance.value / 1000;
                    const straightKm = google.maps.geometry.spherical.computeDistanceBetween(
                        res.routes[0].legs[0].start_location,
                        res.routes[0].legs[0].end_location
                    ) / 1000;

                    const avgKm = (googleKm + straightKm) / 2;
                    const finalKm = Math.round(avgKm * 10) / 10;

                    window.APP.calc.distance = finalKm;

                    if (finalKm > 25) {
                        document.getElementById('error-card').style.display = 'block';
                        document.getElementById('price-card').style.display = 'none';
                        window.APP.calc.price = 0;
                        updateLink();
                        return;
                    }

                    calculatePrice(finalKm);
                    displayPrice();
                    updateLink();
                } else {
                    console.error("Route Failed:", status);
                    window.APP.calc.price = 0;
                    updateLink();
                }
            });
        }

        function calculatePrice(distance) {
            const service = window.APP.service;
            const config = window.APP.config[service];

            if (!config) {
                console.error("Config not loaded yet for:", service);
                return;
            }

            let price = 0;
            if (config.type === 'LINEAR') {
                price = config.base + (distance * config.perKm);
            } else if (config.type === 'TIERED') {
                if (distance <= 2) {
                    price = config.base;
                } else {
                    price = config.base + ((distance - 2) * config.perKm);
                }
            }

            window.APP.calc.price = Math.round(price / 1000) * 1000;
        }

        function displayPrice() {
            const priceCard = document.getElementById('price-card');
            const distDisplay = document.getElementById('dist-display');
            const fakePrice = document.getElementById('fake-price');
            const realPrice = document.getElementById('price-display');

            if (window.APP.calc.distance > 0 && window.APP.calc.price > 0) {
                distDisplay.innerText = `${window.APP.calc.distance} km`;
                const fake = Math.round(window.APP.calc.price * 1.3);
                fakePrice.innerText = `Rp ${fake.toLocaleString('id-ID')}`;
                realPrice.innerText = `Rp ${window.APP.calc.price.toLocaleString('id-ID')}`;
                priceCard.style.display = 'flex';
            } else {
                priceCard.style.display = 'none';
            }
        }

        function updateLink() {
            const btn = document.getElementById('btn-submit');
            const btnText = document.getElementById('btn-text');

            const originVal = document.getElementById('origin').value.trim();
            const destVal = document.getElementById('destination').value.trim();

            if (originVal === '' || destVal === '') {
                btn.classList.add('disabled');
                btn.href = '#';
                btnText.innerText = 'Isi Lokasi Dulu';
                return;
            }

            if (window.APP.calc.price === 0) {
                btn.classList.add('disabled');
                btn.href = '#';
                btnText.innerText = 'Menghitung...';
                return;
            }

            btn.classList.remove('disabled');

            const service = window.APP.service;
            const distance = window.APP.calc.distance;
            const price = window.APP.calc.price;
            const note = document.getElementById('note').value.trim();

            let msg = `*Order ${service}*\n\n`;

            if (service === 'FOOD_MART') {
                const items = document.getElementById('items').value.trim();
                const estPrice = document.getElementById('est-price').value.trim();
                msg += `üìç Beli di: ${originVal}\n`;
                msg += `üèÅ Antar ke: ${destVal}\n`;
                msg += `üìù Item: ${items || '-'}\n`;
                msg += `üí∞ Est. Belanja: Rp ${estPrice ? parseInt(estPrice).toLocaleString('id-ID') : '0'}\n`;
            } else {
                msg += `üìç Jemput: ${originVal}\n`;
                msg += `üèÅ Antar: ${destVal}\n`;
            }

            msg += `üìè Jarak: ${distance} km\n`;
            msg += `üíµ Ongkir: Rp ${price.toLocaleString('id-ID')}\n`;

            if (note) {
                msg += `üí¨ Note: ${note}\n`;
            }

            msg += `\nTerima kasih!`;

            btn.href = `https://wa.me/${CONFIG_WA}?text=${encodeURIComponent(msg)}`;
            btnText.innerText = `Pesan via WhatsApp (Rp ${price.toLocaleString('id-ID')})`;

            // Save to History
            if (window.APP.places.origin && window.APP.places.dest) {
                localStorage.setItem('bantujeg_history', JSON.stringify({
                    origin_addr: originVal,
                    origin_lat: window.APP.places.origin.geometry.location.lat(),
                    origin_lng: window.APP.places.origin.geometry.location.lng(),
                    dest_addr: destVal,
                    dest_lat: window.APP.places.dest.geometry.location.lat(),
                    dest_lng: window.APP.places.dest.geometry.location.lng(),
                    note: note
                }));
            }
        }

        window.setService = function (service, el) {
            window.APP.service = service;

            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            el.classList.add('active');

            // Reset Inputs
            document.getElementById('origin').value = '';
            document.getElementById('destination').value = '';
            document.getElementById('note').value = '';
            document.getElementById('items').value = '';
            document.getElementById('est-price').value = '';

            // Clear Markers
            if (window.APP.markers.origin) {
                window.APP.markers.origin.setMap(null);
                window.APP.markers.origin = null;
            }
            if (window.APP.markers.dest) {
                window.APP.markers.dest.setMap(null);
                window.APP.markers.dest = null;
            }
            if (window.APP.infoWindows.origin) {
                window.APP.infoWindows.origin.close();
                window.APP.infoWindows.origin = null;
            }
            if (window.APP.infoWindows.dest) {
                window.APP.infoWindows.dest.close();
                window.APP.infoWindows.dest = null;
            }

            window.APP.places = { origin: null, dest: null };
            window.APP.calc = { distance: 0, price: 0 };

            document.getElementById('price-card').style.display = 'none';
            document.getElementById('error-card').style.display = 'none';

            toggleClearBtn('origin');
            toggleClearBtn('destination');
            toggleClearBtn('note');

            const jastipFields = document.getElementById('jastip-fields');
            const originInput = document.getElementById('origin');
            const destInput = document.getElementById('destination');

            if (service === 'FOOD_MART') {
                jastipFields.style.display = 'block';
                originInput.placeholder = "Beli di mana? (Warung/Toko)";
                destInput.placeholder = "Antar ke mana? (Lokasi Kamu)";
            } else if (service === 'SEND') {
                jastipFields.style.display = 'none';
                originInput.placeholder = "Ambil paket di mana?";
                destInput.placeholder = "Kirim ke mana?";
            } else { // RIDE
                jastipFields.style.display = 'none';
                originInput.placeholder = "Jemput di mana? (Cari Masjid/Sekolah)";
                destInput.placeholder = "Antar ke mana?";
            }

            updateLink();
        }

        function setLoading(state) {
            const spinner = document.getElementById('loading-spin');
            const text = document.getElementById('btn-text');
            if (state) {
                spinner.style.display = 'block';
                text.style.display = 'none';
            } else {
                spinner.style.display = 'none';
                text.style.display = 'block';
            }
        }

        function expandMap() {
            const container = document.getElementById('map-container');
            container.classList.toggle('expanded');
        }
    </script>

    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAXo3ErccnWYzKPXZsli1j9zsE5_50hO1g&libraries=places,geometry&callback=initMap" async defer></script>
</body>

</html>
