<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#10B981">
    <title>RideNow - Order Your Ride</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary: #10B981;
            --primary-dark: #059669;
            --secondary: #3B82F6;
            --danger: #EF4444;
            --dark: #0F172A;
            --gray-50: #F8FAFC;
            --gray-100: #F1F5F9;
            --gray-200: #E2E8F0;
            --gray-400: #94A3B8;
            --gray-600: #475569;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1);
            --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #ffffff;
            color: var(--dark);
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* HEADER */
        header {
            padding: 16px 20px;
            background: white;
            z-index: 50;
            border-bottom: 1px solid var(--gray-200);
            flex-shrink: 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .brand {
            font-size: 1.5rem;
            font-weight: 800;
            color: var(--primary);
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.75rem;
            color: var(--gray-600);
            font-weight: 600;
        }

        .pulse-dot {
            width: 8px;
            height: 8px;
            background: var(--primary);
            border-radius: 50%;
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.5;
            }
        }

        /* MAP CONTAINER */
        #map-wrapper {
            position: relative;
            width: 100%;
            height: 45vh;
            background: var(--gray-100);
            flex-shrink: 0;
        }

        #map {
            width: 100%;
            height: 100%;
        }

        /* BOTTOM SHEET */
        .bottom-sheet {
            flex: 1;
            background: white;
            border-radius: 24px 24px 0 0;
            margin-top: -20px;
            position: relative;
            z-index: 20;
            box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.08);
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .sheet-handle {
            width: 40px;
            height: 4px;
            background: var(--gray-300);
            border-radius: 2px;
            margin: 12px auto 0;
        }

        .sheet-content {
            padding: 20px;
            flex: 1;
        }

        /* TABS - STICKY */
        .tabs-container {
            position: sticky;
            top: 0;
            background: white;
            z-index: 10;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--gray-100);
            margin-bottom: 20px;
        }

        .tabs {
            display: flex;
            gap: 8px;
            background: var(--gray-50);
            padding: 4px;
            border-radius: 12px;
        }

        .tab {
            flex: 1;
            padding: 12px;
            text-align: center;
            border-radius: 10px;
            font-weight: 700;
            font-size: 0.875rem;
            color: var(--gray-600);
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            white-space: nowrap;
            border: 2px solid transparent;
        }

        .tab.active {
            background: var(--primary);
            color: white;
            box-shadow: var(--shadow-md);
            transform: scale(1.02);
        }

        .tab:active {
            transform: scale(0.98);
        }

        /* INPUT FIELDS */
        .input-group {
            margin-bottom: 14px;
        }

        .input-wrapper {
            display: flex;
            align-items: center;
            gap: 10px;
            background: var(--gray-50);
            border: 2px solid transparent;
            border-radius: 14px;
            padding: 12px 14px;
            transition: all 0.2s;
        }

        .input-wrapper:focus-within {
            background: #F0FDF4;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
        }

        .input-icon {
            font-size: 1.2rem;
            color: var(--gray-400);
            flex-shrink: 0;
        }

        .input-wrapper:focus-within .input-icon {
            color: var(--primary);
        }

        input[type="text"],
        textarea {
            flex: 1;
            background: transparent;
            border: none;
            font-family: inherit;
            font-size: 0.9375rem;
            color: var(--dark);
            outline: none;
            min-width: 0;
        }

        input::placeholder,
        textarea::placeholder {
            color: var(--gray-400);
        }

        textarea {
            resize: none;
            min-height: 60px;
            padding: 4px 0;
        }

        /* ACTION BUTTONS IN INPUT */
        .action-group {
            display: flex;
            align-items: center;
            gap: 6px;
            flex-shrink: 0;
        }

        .clear-btn {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: var(--gray-300);
            color: var(--gray-600);
            display: none;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
        }

        .clear-btn.visible {
            display: flex;
        }

        .clear-btn:hover {
            background: var(--gray-400);
            color: white;
        }

        .gps-btn {
            background: white;
            border: 1px solid var(--gray-200);
            color: var(--primary);
            padding: 6px 12px;
            border-radius: 10px;
            font-size: 0.75rem;
            font-weight: 700;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
            box-shadow: var(--shadow-sm);
            transition: all 0.2s;
            white-space: nowrap;
        }

        .gps-btn:active {
            transform: scale(0.95);
        }

        /* PRICE CARD */
        #price-card {
            background: linear-gradient(135deg, #F0FDF4 0%, #DCFCE7 100%);
            border: 2px solid var(--primary);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
            display: none;
            opacity: 0;
            transform: translateY(10px);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        #price-card.visible {
            display: block;
            opacity: 1;
            transform: translateY(0);
        }

        .price-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .distance-badge {
            background: white;
            color: var(--primary);
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.8125rem;
            font-weight: 700;
            box-shadow: var(--shadow-sm);
        }

        .price-display {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .fake-price {
            font-size: 0.875rem;
            color: var(--gray-500);
            text-decoration: line-through;
            font-weight: 500;
        }

        .real-price {
            font-size: 2rem;
            font-weight: 800;
            color: var(--primary);
            line-height: 1;
        }

        /* ERROR CARD */
        #error-card {
            background: #FEF2F2;
            border: 2px solid var(--danger);
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 20px;
            display: none;
            color: #991B1B;
        }

        #error-card.visible {
            display: block;
        }

        .error-title {
            font-weight: 700;
            font-size: 0.9375rem;
            margin-bottom: 4px;
        }

        .error-message {
            font-size: 0.875rem;
            line-height: 1.4;
        }

        /* LOADING OVERLAY */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(4px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 100;
        }

        .loading-overlay.visible {
            display: flex;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* CTA BUTTON */
        .cta-button {
            width: 100%;
            padding: 18px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 14px;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            box-shadow: var(--shadow-lg);
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .cta-button:disabled {
            background: var(--gray-300);
            color: var(--gray-500);
            cursor: not-allowed;
            box-shadow: none;
        }

        .cta-button:not(:disabled):active {
            transform: scale(0.98);
        }

        .cta-button:not(:disabled):hover {
            background: var(--primary-dark);
        }

        /* RESPONSIVE */
        @media (min-width: 768px) {
            #map-wrapper {
                height: 55vh;
            }
        }
    </style>
</head>
<body>
    <!-- HEADER -->
    <header>
        <div class="brand">RideNow</div>
        <div class="status-indicator">
            <div class="pulse-dot"></div>
            <span id="config-status">Loading...</span>
        </div>
    </header>

    <!-- MAP -->
    <div id="map-wrapper">
        <div id="map"></div>
    </div>

    <!-- BOTTOM SHEET -->
    <div class="bottom-sheet">
        <div class="sheet-handle"></div>
        <div class="sheet-content">
            <!-- STICKY TABS -->
            <div class="tabs-container">
                <div class="tabs">
                    <div class="tab active" onclick="setService('RIDE', this)">üöó RIDE</div>
                    <div class="tab" onclick="setService('SEND', this)">üì¶ SEND</div>
                    <div class="tab" onclick="setService('FOOD', this)">üçî FOOD</div>
                </div>
            </div>

            <!-- ERROR CARD -->
            <div id="error-card">
                <div class="error-title">‚ö†Ô∏è Route Error</div>
                <div class="error-message" id="error-message"></div>
            </div>

            <!-- PRICE CARD -->
            <div id="price-card">
                <div class="price-header">
                    <div class="distance-badge" id="distance-badge">0 km</div>
                </div>
                <div class="price-display">
                    <div class="fake-price" id="fake-price">Rp 0</div>
                    <div class="real-price" id="real-price">Rp 0</div>
                </div>
            </div>

            <!-- ORIGIN INPUT -->
            <div class="input-group">
                <div class="input-wrapper">
                    <div class="input-icon">üìç</div>
                    <input 
                        type="text" 
                        id="origin-input" 
                        placeholder="Pickup location"
                        oninput="handleInput('origin')"
                    />
                    <div class="action-group" id="origin-actions">
                        <div class="gps-btn" onclick="useGPS('origin')">
                            üìç GPS
                        </div>
                        <div class="clear-btn" id="clear-origin" onclick="clearField('origin')">√ó</div>
                    </div>
                </div>
            </div>

            <!-- DESTINATION INPUT -->
            <div class="input-group">
                <div class="input-wrapper">
                    <div class="input-icon">üéØ</div>
                    <input 
                        type="text" 
                        id="destination-input" 
                        placeholder="Drop-off location"
                        oninput="handleInput('destination')"
                    />
                    <div class="action-group" id="destination-actions">
                        <div class="clear-btn" id="clear-destination" onclick="clearField('destination')">√ó</div>
                    </div>
                </div>
            </div>

            <!-- NOTE INPUT -->
            <div class="input-group">
                <div class="input-wrapper">
                    <div class="input-icon">üí¨</div>
                    <textarea 
                        id="note-input" 
                        placeholder="Add notes (optional)"
                        oninput="handleInput('note')"
                    ></textarea>
                    <div class="action-group" style="align-self: flex-start; padding-top: 4px;">
                        <div class="clear-btn" id="clear-note" onclick="clearField('note')">√ó</div>
                    </div>
                </div>
            </div>

            <!-- CTA BUTTON -->
            <button class="cta-button" id="order-button" onclick="placeOrder()" disabled>
                <span id="button-text">Select locations to continue</span>
            </button>
        </div>
    </div>

    <!-- LOADING OVERLAY -->
    <div class="loading-overlay" id="loading-overlay">
        <div class="loading-spinner"></div>
    </div>

    <script type="module">
        // ============================================================
        // STATE ENGINE - SINGLE SOURCE OF TRUTH
        // ============================================================
        const APP = {
            state: {
                origin: null,
                destination: null,
                route: null,
                distanceKm: 0,
                price: 0,
                service: 'RIDE',
                config: null,
                configLoaded: false
            },

            // State update functions
            setOrigin(place) {
                this.state.origin = place;
                this.recompute();
                this.renderUI();
            },

            setDestination(place) {
                this.state.destination = place;
                this.recompute();
                this.renderUI();
            },

            setService(type) {
                this.state.service = type;
                this.resetState();
                this.renderUI();
            },

            updateDistance(km) {
                this.state.distanceKm = km;
                this.renderUI();
            },

            updatePrice(price) {
                this.state.price = price;
                this.renderUI();
            },

            setRoute(route) {
                this.state.route = route;
                this.renderUI();
            },

            setConfig(config) {
                this.state.config = config;
                this.state.configLoaded = true;
                this.renderUI();
            },

            resetState() {
                this.state.origin = null;
                this.state.destination = null;
                this.state.route = null;
                this.state.distanceKm = 0;
                this.state.price = 0;
            },

            recompute() {
                if (this.state.origin && this.state.destination) {
                    RouteEngine.calculateRoute(this.state.origin, this.state.destination);
                }
            },

            renderUI() {
                UIEngine.render(this.state);
            }
        };

        // ============================================================
        // MAP ENGINE - VISUAL ONLY
        // ============================================================
        const MapEngine = {
            map: null,
            originMarker: null,
            destinationMarker: null,
            directionsRenderer: null,

            init() {
                this.map = new google.maps.Map(document.getElementById('map'), {
                    center: { lat: -6.2088, lng: 106.8456 },
                    zoom: 13,
                    disableDefaultUI: true,
                    zoomControl: true,
                    styles: [
                        {
                            featureType: 'poi',
                            stylers: [{ visibility: 'off' }]
                        }
                    ]
                });

                this.directionsRenderer = new google.maps.DirectionsRenderer({
                    map: this.map,
                    suppressMarkers: true,
                    polylineOptions: {
                        strokeColor: '#3B82F6',
                        strokeWeight: 5,
                        strokeOpacity: 0.8
                    }
                });
            },

            setOriginMarker(location) {
                if (this.originMarker) {
                    this.originMarker.setMap(null);
                }

                this.originMarker = new google.maps.Marker({
                    position: location,
                    map: this.map,
                    icon: {
                        path: google.maps.SymbolPath.CIRCLE,
                        scale: 12,
                        fillColor: '#10B981',
                        fillOpacity: 1,
                        strokeColor: '#ffffff',
                        strokeWeight: 3
                    },
                    animation: google.maps.Animation.DROP
                });

                this.fitBounds();
            },

            setDestinationMarker(location) {
                if (this.destinationMarker) {
                    this.destinationMarker.setMap(null);
                }

                this.destinationMarker = new google.maps.Marker({
                    position: location,
                    map: this.map,
                    icon: {
                        path: google.maps.SymbolPath.CIRCLE,
                        scale: 12,
                        fillColor: '#EF4444',
                        fillOpacity: 1,
                        strokeColor: '#ffffff',
                        strokeWeight: 3
                    },
                    animation: google.maps.Animation.DROP
                });

                this.fitBounds();
            },

            drawRoute(route) {
                if (route) {
                    this.directionsRenderer.setDirections(route);
                }
            },

            clearRoute() {
                this.directionsRenderer.setDirections({ routes: [] });
            },

            fitBounds() {
                const bounds = new google.maps.LatLngBounds();
                if (this.originMarker) bounds.extend(this.originMarker.getPosition());
                if (this.destinationMarker) bounds.extend(this.destinationMarker.getPosition());
                
                if (!bounds.isEmpty()) {
                    this.map.fitBounds(bounds);
                    const zoom = this.map.getZoom();
                    if (zoom > 16) this.map.setZoom(16);
                }
            }
        };

        // ============================================================
        // ROUTE ENGINE
        // ============================================================
        const RouteEngine = {
            directionsService: null,

            init() {
                this.directionsService = new google.maps.DirectionsService();
            },

            calculateRoute(origin, destination) {
                if (!origin || !destination) return;

                const request = {
                    origin: origin,
                    destination: destination,
                    travelMode: google.maps.TravelMode.DRIVING
                };

                this.directionsService.route(request, (result, status) => {
                    if (status === 'OK') {
                        const route = result.routes[0];
                        const distanceMeters = route.legs[0].distance.value;
                        const distanceKm = Math.round(distanceMeters / 1000 * 10) / 10;

                        APP.state.route = result;
                        APP.updateDistance(distanceKm);

                        const price = PricingEngine.calculatePrice(distanceKm, APP.state.config);
                        APP.updatePrice(price);

                        MapEngine.drawRoute(result);
                        UIEngine.hideError();
                    } else {
                        UIEngine.showError('Unable to calculate route. Please try different locations.');
                        APP.state.route = null;
                        APP.updateDistance(0);
                        APP.updatePrice(0);
                    }
                });
            }
        };

        // ============================================================
        // PRICING ENGINE - PURE CALCULATION
        // ============================================================
        const PricingEngine = {
            calculatePrice(distanceKm, config) {
                if (!config || !distanceKm) return 0;

                let price = 0;
                const serviceConfig = config[APP.state.service] || config.RIDE;

                if (serviceConfig.type === 'LINEAR') {
                    price = serviceConfig.base + (distanceKm * serviceConfig.perKm);
                } else if (serviceConfig.type === 'TIERED') {
                    if (distanceKm <= 2) {
                        price = serviceConfig.base;
                    } else {
                        price = serviceConfig.base + ((distanceKm - 2) * serviceConfig.perKm);
                    }
                }

                price = Math.max(0, Math.round(price / 1000) * 1000);
                return isNaN(price) || !isFinite(price) ? 0 : price;
            }
        };

        // ============================================================
        // UI ENGINE - RENDERING ONLY
        // ============================================================
        const UIEngine = {
            render(state) {
                this.updatePriceCard(state);
                this.updateButton(state);
                this.updateStatusIndicator(state);
                this.updateMarkers(state);
            },

            updatePriceCard(state) {
                const card = document.getElementById('price-card');
                const distanceBadge = document.getElementById('distance-badge');
                const fakePrice = document.getElementById('fake-price');
                const realPrice = document.getElementById('real-price');

                if (state.distanceKm > 0 && state.price > 0) {
                    distanceBadge.textContent = `${state.distanceKm} km`;
                    const fake = Math.round(state.price * 1.3);
                    fakePrice.textContent = `Rp ${fake.toLocaleString('id-ID')}`;
                    realPrice.textContent = `Rp ${state.price.toLocaleString('id-ID')}`;
                    card.classList.add('visible');
                } else {
                    card.classList.remove('visible');
                }
            },

            updateButton(state) {
                const button = document.getElementById('order-button');
                const buttonText = document.getElementById('button-text');

                if (!state.configLoaded) {
                    button.disabled = true;
                    buttonText.textContent = 'Loading config...';
                } else if (!state.origin || !state.destination) {
                    button.disabled = true;
                    buttonText.textContent = 'Select locations to continue';
                } else if (state.price === 0) {
                    button.disabled = true;
                    buttonText.textContent = 'Calculating price...';
                } else {
                    button.disabled = false;
                    buttonText.textContent = `Order ${state.service} - Rp ${state.price.toLocaleString('id-ID')}`;
                }
            },

            updateStatusIndicator(state) {
                const status = document.getElementById('config-status');
                if (state.configLoaded) {
                    status.textContent = 'Ready';
                } else {
                    status.textContent = 'Loading...';
                }
            },

            updateMarkers(state) {
                if (state.origin) {
                    MapEngine.setOriginMarker(state.origin);
                }
                if (state.destination) {
                    MapEngine.setDestinationMarker(state.destination);
                }
            },

            showError(message) {
                const errorCard = document.getElementById('error-card');
                const errorMessage = document.getElementById('error-message');
                errorMessage.textContent = message;
                errorCard.classList.add('visible');
            },

            hideError() {
                const errorCard = document.getElementById('error-card');
                errorCard.classList.remove('visible');
            },

            showLoading() {
                document.getElementById('loading-overlay').classList.add('visible');
            },

            hideLoading() {
                document.getElementById('loading-overlay').classList.remove('visible');
            }
        };

        // ============================================================
        // FIREBASE CONFIG LOADER
        // ============================================================
        const ConfigLoader = {
            async loadConfig() {
                try {
                    const response = await fetch('https://firebasestorage.googleapis.com/v0/b/bantujeg.appspot.com/o/pricing_config.json?alt=media');
                    const config = await response.json();
                    APP.setConfig(config);
                } catch (error) {
                    console.error('Config load failed:', error);
                    UIEngine.showError('Failed to load pricing config. Please refresh.');
                }
            }
        };

        // ============================================================
        // AUTOCOMPLETE SETUP
        // ============================================================
        let originAutocomplete, destinationAutocomplete;

        function setupAutocomplete() {
            const originInput = document.getElementById('origin-input');
            const destinationInput = document.getElementById('destination-input');

            originAutocomplete = new google.maps.places.Autocomplete(originInput, {
                componentRestrictions: { country: 'id' },
                fields: ['geometry', 'formatted_address', 'name']
            });

            destinationAutocomplete = new google.maps.places.Autocomplete(destinationInput, {
                componentRestrictions: { country: 'id' },
                fields: ['geometry', 'formatted_address', 'name']
            });

            originAutocomplete.addListener('place_changed', () => {
                const place = originAutocomplete.getPlace();
                if (place.geometry) {
                    APP.setOrigin(place.geometry.location);
                }
            });

            destinationAutocomplete.addListener('place_changed', () => {
                const place = destinationAutocomplete.getPlace();
                if (place.geometry) {
                    APP.setDestination(place.geometry.location);
                }
            });
        }

        // ============================================================
        // INPUT HANDLERS
        // ============================================================
        window.handleInput = function(field) {
            const input = document.getElementById(`${field}-input`);
            const clearBtn = document.getElementById(`clear-${field}`);
            
            if (input.value.trim().length > 0) {
                clearBtn.classList.add('visible');
            } else {
                clearBtn.classList.remove('visible');
            }
        };

        window.clearField = function(field) {
            const input = document.getElementById(`${field}-input`);
            input.value = '';
            
            const clearBtn = document.getElementById(`clear-${field}`);
            clearBtn.classList.remove('visible');

            if (field === 'origin') {
                APP.setOrigin(null);
                if (MapEngine.originMarker) {
                    MapEngine.originMarker.setMap(null);
                    MapEngine.originMarker = null;
                }
            } else if (field === 'destination') {
                APP.setDestination(null);
                if (MapEngine.destinationMarker) {
                    MapEngine.destinationMarker.setMap(null);
                    MapEngine.destinationMarker = null;
                }
            }

            MapEngine.clearRoute();
            input.focus();
        };

        window.useGPS = function(field) {
            if (!navigator.geolocation) {
                UIEngine.showError('GPS not supported by your browser');
                return;
            }

            UIEngine.showLoading();

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const location = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };

                    const geocoder = new google.maps.Geocoder();
                    geocoder.geocode({ location }, (results, status) => {
                        UIEngine.hideLoading();
                        
                        if (status === 'OK' && results[0]) {
                            const input = document.getElementById(`${field}-input`);
                            input.value = results[0].formatted_address;
                            
                            if (field === 'origin') {
                                APP.setOrigin(new google.maps.LatLng(location.lat, location.lng));
                            } else {
                                APP.setDestination(new google.maps.LatLng(location.lat, location.lng));
                            }
                            
                            handleInput(field);
                        } else {
                            UIEngine.showError('Unable to get address from GPS location');
                        }
                    });
                },
                (error) => {
                    UIEngine.hideLoading();
                    UIEngine.showError('GPS access denied. Please enable location services.');
                }
            );
        };

        window.setService = function(type, element) {
            APP.setService(type);

            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            if (element) element.classList.add('active');

            document.getElementById('origin-input').value = '';
            document.getElementById('destination-input').value = '';
            document.getElementById('note-input').value = '';
            
            document.querySelectorAll('.clear-btn').forEach(btn => btn.classList.remove('visible'));

            if (MapEngine.originMarker) {
                MapEngine.originMarker.setMap(null);
                MapEngine.originMarker = null;
            }
            if (MapEngine.destinationMarker) {
                MapEngine.destinationMarker.setMap(null);
                MapEngine.destinationMarker = null;
            }
            MapEngine.clearRoute();

            const placeholders = {
                RIDE: {
                    origin: 'Pickup location',
                    destination: 'Drop-off location'
                },
                SEND: {
                    origin: 'Package pickup location',
                    destination: 'Package delivery location'
                },
                FOOD: {
                    origin: 'Restaurant location',
                    destination: 'Delivery address'
                }
            };

            document.getElementById('origin-input').placeholder = placeholders[type].origin;
            document.getElementById('destination-input').placeholder = placeholders[type].destination;
        };

        window.placeOrder = function() {
            if (!APP.state.origin || !APP.state.destination || APP.state.price === 0) {
                return;
            }

            const originAddr = document.getElementById('origin-input').value;
            const destAddr = document.getElementById('destination-input').value;
            const note = document.getElementById('note-input').value;

            const message = `*New ${APP.state.service} Order*

üìç Pickup: ${originAddr}
üéØ Destination: ${destAddr}
üìè Distance: ${APP.state.distanceKm} km
üí∞ Price: Rp ${APP.state.price.toLocaleString('id-ID')}
${note ? `\nüí¨ Note: ${note}` : ''}

Ready to serve!`;

            const whatsappNumber = '6282110025455';
            const whatsappURL = `https://wa.me/${whatsappNumber}?text=${encodeURIComponent(message)}`;
            
            window.open(whatsappURL, '_blank');
        };

        // ============================================================
        // INITIALIZATION
        // ============================================================
        window.initMap = function() {
            MapEngine.init();
            RouteEngine.init();
            setupAutocomplete();
            ConfigLoader.loadConfig();
        };

        // Load Google Maps API
        const script = document.createElement('script');
        script.src = 'https://maps.googleapis.com/maps/api/js?key=AIzaSyAXo3ErccnWYzKPXZsli1j9zsE5_50hO1g&libraries=places,geometry&callback=initMap';
        script.async = true;
        script.defer = true;
        document.body.appendChild(script);
    </script>
</body>
</html>
